<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <link rel="icon" href="dist/favicon/expense.ico"/>
    <title>æ¶ˆè´¹ç›˜ç‚¹</title>
    <!-- Bootstrap & jQueryï¼ˆä¸ç°é¡µä¸€è‡´çš„æŠ€æœ¯æ ˆï¼‰ -->
    <link rel="stylesheet" type="text/css" href="dist/css/c070423032508.css">
    <link rel="stylesheet" type="text/css" href="dist/css/c220423282110.css">
    <link rel="stylesheet" href="dist/css/bootstrap.min.css">
    <script src="dist/js/jquery-3.7.0.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <script src="dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: #fff;
            padding-bottom: 60px;
        }

        .page-title {
            font-weight: 700;
            letter-spacing: .5px;
        }

        .th-info {
            color: #6c757d;
            font-weight: 400;
            font-size: .85rem;
        }

        .card-soft {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: .75rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .03);
        }

        .table thead th {
            white-space: nowrap;
            vertical-align: bottom;
            position: sticky;
            top: 0;
            z-index: 2;
            background: #212529;
            color: #fff;
            border-color: #212529;
        }

        .table td, .table th {
            vertical-align: middle;
        }

        .num {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .muted {
            color: #6c757d;
        }

        .tfoot-total td {
            font-weight: 800;
            font-size: 1.05rem;
            background: #fcfcfd;
            border-top: 2px solid #343a40;
        }

        .btn-black {
            background: #000;
            color: #fff;
        }

        .btn-black:hover {
            color: #fff;
            filter: brightness(1.1);
        }

        .tag {
            padding: .2rem .4rem;
            border-radius: .35rem;
            background: #f1f3f5;
            font-size: .8rem;
        }

        .table-responsive {
            width: 100%;
        }

        .table {
            width: 100%;
        }

        .bottom-navigation {
            z-index: 1000;
        }

        .btn-ops-group .btn {
            margin: 0 .15rem;
        }

        /* åˆ—éšè—ç»Ÿä¸€æ ·å¼ */
        .col-hidden {
            display: none !important;
        }

        /* ====== å›¾è¡¨åŒºåŸŸæ ·å¼ï¼ˆä¸ç°æœ‰é£æ ¼ç»Ÿä¸€ï¼‰ ====== */
        .chart-wrap {
            position: relative;
            min-height: 260px;
        }

        .legend {
            line-height: 1.2;
        }

        .legend .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #e9ecef;
            border-radius: .5rem;
            padding: .4rem .6rem;
            background: #fff;
            margin-bottom: .5rem;
        }

        .legend .legend-left {
            display: flex;
            align-items: center;
            min-width: 0;
        }

        .legend .legend-box {
            width: 14px;
            height: 14px;
            border: 1px solid #ced4da;
            margin-right: 8px;
        }

        .legend .legend-label {
            font-weight: 600;
            color: #212529;
            white-space: nowrap;
        }

        .legend .legend-right {
            text-align: right;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            margin-left: 8px;
        }

        .legend .legend-amt {
            color: #212529;
        }

        .legend .legend-pct {
            color: #6c757d;
            margin-left: 6px;
        }

        .chart-empty {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: .95rem;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px dashed #e9ecef;
            border-radius: .75rem;
        }

        .chart-empty.show {
            display: flex;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4 px-3">
    <div class="d-flex align-items-center mb-3">
        <h2 class="page-title mb-0">æ¶ˆè´¹ç›˜ç‚¹</h2>
        <div class="ml-3 tag">æ—¥å‡ / æœˆå‡ / å¹´å‡ / 30å¹´ / <span id="yearsLabel">--</span>å¹´</div>
    </div>

    <!-- ===== æ–°å¢ï¼šç±»ç›®æ¶ˆè´¹å æ¯”ï¼ˆåœ†ç¯å›¾ï¼‰ ===== -->
    <div class="card-soft p-3 mb-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 mr-2">ç±»ç›®æ¶ˆè´¹å æ¯”</h5>
                <span class="th-info">å£å¾„ï¼šå¹´å‡é‡‘é¢ï¼ˆ=æ—¥å‡Ã—365ï¼‰</span>
            </div>
            <div id="chartSummary" class="small text-muted">â€”</div>
        </div>
        <div class="row align-items-center">
            <div class="col-md-7">
                <div class="chart-wrap p-2">
                    <canvas id="categoryChart" height="200"></canvas>
                    <div id="chartEmpty" class="chart-empty">æš‚æ— æ•°æ®</div>
                </div>
            </div>
            <div class="col-md-5">
                <div id="categoryLegend" class="legend small"></div>
            </div>
        </div>
    </div>

    <!-- æ§ä»¶åŒº -->
    <div class="card-soft p-3 mb-3">
        <div class="d-flex flex-wrap align-items-center">
            <div class="mr-2 mb-2">
                <button id="addRow" class="btn btn-outline-secondary">ï¼‹ æ·»åŠ ä¸€è¡Œ</button>
            </div>
            <div class="mr-2 mb-2">
                <button id="restoreTemplate" class="btn btn-outline-secondary">â†º æ¢å¤ç¤ºä¾‹æ¨¡æ¿</button>
            </div>
            <div class="mr-2 mb-2">
                <button id="clearAll" class="btn btn-outline-secondary">ğŸ—‘ æ¸…ç©ºå…¨éƒ¨</button>
            </div>

            <!-- å¯¼å…¥/å¯¼å‡º -->
            <div class="mr-2 mb-2">
                <button id="importCSV" class="btn btn-outline-primary">â¤’ å¯¼å…¥ CSV</button>
                <input id="importFile" type="file" accept=".csv,text/csv" class="d-none"/>
            </div>
            <div class="mr-2 mb-2">
                <button id="exportCSV" class="btn btn-black">â¤“ å¯¼å‡º CSV</button>
            </div>
        </div>

        <!-- æ˜¾ç¤ºåˆ—æ§åˆ¶ -->
        <div class="mt-2">
            <div class="small text-muted mb-1">æ˜¾ç¤ºåˆ—ï¼ˆå¯å‹¾é€‰/å–æ¶ˆï¼Œæ”¯æŒæŒä¹…åŒ–è®°å¿†ï¼‰</div>
            <div class="d-flex flex-wrap align-items-center">
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggleDaily" checked> æ—¥å‡
                </label>
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggleMonthly" checked> æœˆå‡
                </label>
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggleYearly" checked> å¹´å‡
                </label>
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggle30y" checked> 30å¹´
                </label>
                <label class="mr-3 mb-2 d-flex align-items-center">
                    <input type="checkbox" id="toggleCustom" checked> <span class="ml-1" id="yearsLabel2">è‡ªå®šä¹‰</span>å¹´
                </label>
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-responsive">
        <table id="expenseTable" class="table table-hover table-bordered mb-0">
            <thead class="thead-dark">
            <tr>
                <th style="min-width:90px;">ç±»ç›®</th>
                <th style="min-width:180px;">é¡¹ç›®</th>
                <th style="min-width:100px;">å‘¨æœŸ</th>
                <th class="num">æ”¯å‡ºÂ¥</th>
                <th class="num th-daily">æ—¥å‡Â¥</th>
                <th class="num th-monthly">æœˆå‡Â¥</th>
                <th class="num th-yearly">å¹´å‡Â¥</th>
                <th class="num th-30y">30å¹´Â¥</th>
                <th class="num th-custom">
                    <div class="d-flex align-items-center justify-content-center">
                        <select id="yearsSelect" class="custom-select custom-select-sm w-auto"></select>
                        <span class="ml-1">Â¥</span>
                    </div>
                </th>
                <th class="text-center" style="min-width:90px;">æ“ä½œ</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
            <tfoot>
            <tr class="tfoot-total">
                <td colspan="3" class="text-right">åˆè®¡</td>
                <td class="num" id="sumD">0.00</td>
                <td class="num tfoot-daily" id="sumE">0.00</td>
                <td class="num tfoot-monthly" id="sumF">0.00</td>
                <td class="num tfoot-yearly" id="sumG">0.00</td>
                <td class="num tfoot-30y" id="sumH">0.00</td>
                <td class="num tfoot-custom" id="sumI">0.00</td>
                <td></td>
            </tr>
            </tfoot>
        </table>
    </div>

    <div class="small text-muted mt-2">
        å‘¨æœŸå¤©æ•°æ˜ å°„ï¼šæ¯å¤©=1ï¼Œ æ¯å‘¨=7ï¼Œ æ¯æœˆ=30ï¼Œ æ¯å¹´=365ï¼Œ
        æ¯2å¹´=730...
    </div>
</div>

<div class="bottom-navigation">
    <a href="index.html">ğŸ’° FIREè®¡ç®—å™¨</a>
    <a href="life.html">â° ç”Ÿå‘½å€’è®¡æ—¶</a>
    <a href="expense.html">ğŸ§¾ æ¶ˆè´¹ç›˜ç‚¹</a>
    <!--<a href="clock.html">â° FIREæ—¶é’Ÿ</a>-->
    <a href="rental.html">ğŸ  æˆ¿äº§ç§Ÿå”®æ¯”</a>
</div>

<!-- å¼•å…¥ Chart.jsï¼ˆä¸è®¡ç®—å™¨é¡µä¸€è‡´çš„è·¯å¾„ï¼‰ -->
<script src="dist/chart.min.js"></script>

<script>
    /* ===== é…ç½® ===== */
    // æ‰©å±•å‘¨æœŸå¯é€‰é¡¹ï¼šæ–°å¢ æ¯6å¹´~æ¯10å¹´
    const PERIOD_OPTIONS = [
        "æ¯å¤©", "æ¯å‘¨", "æ¯æœˆ", "æ¯å¹´",
        "æ¯2å¹´", "æ¯3å¹´", "æ¯4å¹´", "æ¯5å¹´",
        "æ¯6å¹´", "æ¯7å¹´", "æ¯8å¹´", "æ¯9å¹´", "æ¯10å¹´"
    ];
    const PERIOD_TO_DAYS = {
        "æ¯å¤©": 1, "æ¯å‘¨": 7, "æ¯æœˆ": 30, "æ¯å¹´": 365,
        "æ¯2å¹´": 2 * 365, "æ¯3å¹´": 3 * 365, "æ¯4å¹´": 4 * 365, "æ¯5å¹´": 5 * 365,
        "æ¯6å¹´": 6 * 365, "æ¯7å¹´": 7 * 365, "æ¯8å¹´": 8 * 365, "æ¯9å¹´": 9 * 365, "æ¯10å¹´": 10 * 365
    };
    const CATEGORY_OPTIONS = ["é¥®é£Ÿ", "å¨±ä¹", "ç”µå­", "ç”Ÿæ´»", "å®¶ç”µ", "äº¤é€š", "æ—…æ¸¸", "å…¶å®ƒ"];

    const YEARS_DEFAULT = 40;
    const LS_KEY = 'expense_rows_v1';
    const LS_YEARS_KEY = 'expense_years_v1';

    // åˆ—æ˜¾ç¤ºçŠ¶æ€æŒä¹…åŒ–é”®
    const LS_COLS_KEY = 'expense_cols_visibility_v1';
    // åˆ—é€‰æ‹©å™¨å®šä¹‰
    const COLS = {
        daily: {th: '.th-daily', tds: 'td.cell-daily', tf: 'td.tfoot-daily'},
        monthly: {th: '.th-monthly', tds: 'td.cell-monthly', tf: 'td.tfoot-monthly'},
        yearly: {th: '.th-yearly', tds: 'td.cell-yearly', tf: 'td.tfoot-yearly'},
        y30: {th: '.th-30y', tds: 'td.cell-30y', tf: 'td.tfoot-30y'},
        custom: {th: '.th-custom', tds: 'td.cell-custom-y', tf: 'td.tfoot-custom'}
    };

    let selectedYears = YEARS_DEFAULT;

    /* ç¤ºä¾‹æ¨¡æ¿(ä¿æŒä¸å˜ï¼Œå¯è‡ªç”±ç¼–è¾‘) */
    const TEMPLATE_ROWS = [
        {cat: "é¥®é£Ÿ", name: "æ—©é¤", period: "æ¯å¤©", amount: 3},
        {cat: "é¥®é£Ÿ", name: "ä¸­é¥­(è‡ªå·±åš)", period: "æ¯å¤©", amount: 15},
        {cat: "é¥®é£Ÿ", name: "æ™šé¥­(é¸¡è›‹+ç‰›å¥¶+ç‰ç±³ç­‰)", period: "æ¯å¤©", amount: 7},
        {cat: "é¥®é£Ÿ", name: "æ°´æœ", period: "æ¯å¤©", amount: 6},
        {cat: "é¥®é£Ÿ", name: "åƒå¤§é¤(æ¯æœˆ2~3æ¬¡)", period: "æ¯æœˆ", amount: 200},
        {cat: "å¨±ä¹", name: "ç”µå½±ç¥¨(æ¯æœˆ2~3å¼ )", period: "æ¯æœˆ", amount: 200},
        {cat: "ç”µå­", name: "æ‰‹æœº", period: "æ¯3å¹´", amount: 3000},
        {cat: "ç”µå­", name: "ç”µè„‘(å«æ˜¾å¡)", period: "æ¯4å¹´", amount: 8000},
        {cat: "ç”µå­", name: "å¤–è®¾(æ˜¾ç¤ºå™¨/éŸ³ç®±)", period: "æ¯4å¹´", amount: 5000},
        {cat: "ç”Ÿæ´»", name: "è¯è´¹+ç½‘è´¹(ç”µä¿¡1000M)", period: "æ¯æœˆ", amount: 199},
        {cat: "ç”Ÿæ´»", name: "è¿åŠ¨å™¨æ¢°(å«æŸåæ›´æ¢)", period: "æ¯å¹´", amount: 1000},
        {cat: "ç”Ÿæ´»", name: "æ°´ç”µç‡ƒæ°”", period: "æ¯å¹´", amount: 3000},
        {cat: "ç”Ÿæ´»", name: "ç‰©ä¸šè´¹(å«æŸè€—ç»´æŠ¤)", period: "æ¯å¹´", amount: 1500},
        {cat: "å®¶ç”µ", name: "å†°ç®±", period: "æ¯5å¹´", amount: 1500},
        {cat: "å®¶ç”µ", name: "æ´—è¡£æœº", period: "æ¯5å¹´", amount: 2000},
        {cat: "å®¶ç”µ", name: "çƒ˜å¹²æœº", period: "æ¯5å¹´", amount: 2000},
        {cat: "å®¶ç”µ", name: "ç©ºè°ƒ", period: "æ¯5å¹´", amount: 2000},
        {cat: "äº¤é€š", name: "äº¤é€šè´¹(å¸‚åŸŸåœ°é“)", period: "æ¯æœˆ", amount: 40},
        {cat: "äº¤é€š", name: "äº¤é€šè´¹(åŸé™…é«˜é“)", period: "æ¯å¹´", amount: 1000},
        {cat: "äº¤é€š", name: "äº¤é€šè´¹(å°ç”µé©´åŠå……ç”µ)", period: "æ¯3å¹´", amount: 3000},
        {cat: "æ—…æ¸¸", name: "", period: "æ¯å¹´", amount: 0},
        {cat: "å…¶å®ƒ", name: "è¡£ç‰©/æ—¥ç”¨/åŒ»ç–—/äººæƒ…/å­¦ä¹ â€¦", period: "æ¯å¹´", amount: 1000}
    ];

    /* ===== å·¥å…·å‡½æ•° ===== */
    const fmt = n => Number(n || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    // åˆè®¡ä½¿ç”¨â€œçº¯æ•°å­—â€ï¼ˆæ— åƒåˆ†ä½ï¼‰
    const fmtPlain = n => (Number(n || 0)).toFixed(2);
    const parseNum = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    function calcByDays(amount, days) {
        if (!days) return {E: 0, F: 0, G: 0, H: 0, I: 0};
        const E = amount / days;   // æ—¥å‡
        const F = E * 30;          // æœˆå‡
        const G = E * 365;         // å¹´å‡
        const H = G * 30;          // 30å¹´
        const I = G * selectedYears; // Nå¹´ï¼ˆä¸‹æ‹‰å¯é€‰ï¼‰
        return {E, F, G, H, I};
    }

    function buildSelect(options, selected) {
        const $sel = $('<select class="form-control form-control-sm"></select>');
        options.forEach(opt => {
            $sel.append(`<option ${opt === selected ? 'selected' : ''}>${opt}</option>`);
        });
        return $sel;
    }

    function buildRow(data = {cat: "å…¶å®ƒ", name: "", period: "æ¯æœˆ", amount: 0}) {
        const $tr = $('<tr></tr>');
        const $cat = buildSelect(CATEGORY_OPTIONS, data.cat).addClass('input-cat');
        const $name = $(`<input type="text" class="form-control form-control-sm input-name" placeholder="">`).val(data.name);
        const $period = buildSelect(PERIOD_OPTIONS, data.period).addClass('select-period');
        const $amount = $(`<input type="number" class="form-control form-control-sm input-amount num" step="0.01" min="0">`).val(data.amount);

        const $tdCat = $('<td></td>').append($cat);
        const $tdName = $('<td></td>').append($name);
        const $tdPer = $('<td></td>').append($period);
        const $tdAmt = $('<td class="num"></td>').append($amount);
        const $tdE = $('<td class="num cell-daily">0.00</td>');
        const $tdF = $('<td class="num cell-monthly">0.00</td>');
        const $tdG = $('<td class="num cell-yearly">0.00</td>');
        const $tdH = $('<td class="num cell-30y">0.00</td>');
        const $tdI = $('<td class="num cell-custom-y">0.00</td>');

        // æ“ä½œåˆ—ï¼šä¸Šç§» / ä¸‹ç§» / åˆ é™¤
        const $btnUp = $('<button class="btn btn-sm btn-outline-secondary btn-move-up" title="ä¸Šç§»">â†‘</button>');
        const $btnDown = $('<button class="btn btn-sm btn-outline-secondary btn-move-down" title="ä¸‹ç§»">â†“</button>');
        const $btnDel = $('<button class="btn btn-sm btn-outline-danger btn-del" title="åˆ é™¤">åˆ é™¤</button>');
        const $opsWrap = $('<div class="btn-ops-group d-inline-flex align-items-center"></div>').append($btnUp, $btnDown, $btnDel);
        const $tdOps = $('<td class="text-center"></td>').append($opsWrap);

        $tr.append($tdCat, $tdName, $tdPer, $tdAmt, $tdE, $tdF, $tdG, $tdH, $tdI, $tdOps);

        // äº‹ä»¶
        $tr.on('input change', '.input-amount, .select-period, .input-name, .input-cat', () => {
            computeRow($tr);
            computeTotals();
            saveToLocalStorage();
            updateCategoryChart(); // å›¾è¡¨è”åŠ¨
        });

        $tr.on('click', '.btn-del', () => {
            $tr.remove();
            computeTotals();
            saveToLocalStorage();
            updateMoveButtons();
            updateCategoryChart(); // å›¾è¡¨è”åŠ¨
        });

        $tr.on('click', '.btn-move-up', () => {
            const $prev = $tr.prev('tr');
            if ($prev.length) {
                $tr.insertBefore($prev);
                computeTotals();
                saveToLocalStorage();
                updateMoveButtons();
                updateCategoryChart(); // å›¾è¡¨è”åŠ¨
            }
        });

        $tr.on('click', '.btn-move-down', () => {
            const $next = $tr.next('tr');
            if ($next.length) {
                $tr.insertAfter($next);
                computeTotals();
                saveToLocalStorage();
                updateMoveButtons();
                updateCategoryChart(); // å›¾è¡¨è”åŠ¨
            }
        });

        computeRow($tr);
        return $tr;
    }

    function updateMoveButtons() {
        const $rows = $('#tbody tr');
        $rows.find('.btn-move-up, .btn-move-down').prop('disabled', false);
        if ($rows.length === 0) return;
        $rows.first().find('.btn-move-up').prop('disabled', true);
        $rows.last().find('.btn-move-down').prop('disabled', true);
    }

    function computeRow($tr) {
        const amount = parseNum($tr.find('.input-amount').val());
        const period = $tr.find('.select-period').val();
        const days = PERIOD_TO_DAYS[period] || 0;
        const {E, F, G, H, I} = calcByDays(amount, days);
        $tr.find('.cell-daily').text(fmt(E));
        $tr.find('.cell-monthly').text(fmt(F));
        $tr.find('.cell-yearly').text(fmt(G));
        $tr.find('.cell-30y').text(fmt(H));
        $tr.find('.cell-custom-y').text(fmt(I));
    }

    function computeTotals() {
        let sumD = 0, sumE = 0, sumF = 0, sumG = 0, sumH = 0, sumI = 0;
        $('#tbody tr').each(function () {
            const $tr = $(this);
            const amount = parseNum($tr.find('.input-amount').val());
            const e = parseNum($tr.find('.cell-daily').text().replace(/,/g, ''));
            const f = parseNum($tr.find('.cell-monthly').text().replace(/,/g, ''));
            const g = parseNum($tr.find('.cell-yearly').text().replace(/,/g, ''));
            const h = parseNum($tr.find('.cell-30y').text().replace(/,/g, ''));
            const i = parseNum($tr.find('.cell-custom-y').text().replace(/,/g, ''));
            sumD += amount;
            sumE += e;
            sumF += f;
            sumG += g;
            sumH += h;
            sumI += i;
        });
        $('#sumD').text(fmtPlain(sumD));
        $('#sumE').text(fmtPlain(sumE));
        $('#sumF').text(fmtPlain(sumF));
        $('#sumG').text(fmtPlain(sumG));
        $('#sumH').text(fmtPlain(sumH));
        $('#sumI').text(fmtPlain(sumI));
        // æ±‡æ€»æ–‡å­—ï¼ˆå›¾è¡¨å³ä¸Šè§’ï¼‰
        const sumGNum = Number(sumG || 0);
        document.getElementById('chartSummary').textContent =
            'å¹´å‡åˆè®¡ï¼šÂ¥ ' + sumGNum.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function recomputeAll() {
        $('#tbody tr').each(function () {
            computeRow($(this));
        });
        computeTotals();
        updateMoveButtons();
    }

    /* ===== LocalStorageï¼ˆè¡Œæ•°æ®ï¼‰ ===== */
    function saveToLocalStorage() {
        const rows = [];
        $('#tbody tr').each(function () {
            rows.push({
                cat: $(this).find('.input-cat').val(),
                name: $(this).find('.input-name').val(),
                period: $(this).find('.select-period').val(),
                amount: parseNum($(this).find('.input-amount').val())
            });
        });
        localStorage.setItem(LS_KEY, JSON.stringify(rows));
    }

    function loadFromLocalStorage() {
        try {
            const json = localStorage.getItem(LS_KEY);
            if (!json) return null;
            const rows = JSON.parse(json);
            if (!Array.isArray(rows)) return null;
            return rows;
        } catch (e) {
            return null;
        }
    }

    function clearLocal() {
        localStorage.removeItem(LS_KEY);
    }

    /* ===== LocalStorageï¼ˆå¹´æ•°ï¼‰ ===== */
    function saveYearsToLocalStorage() {
        localStorage.setItem(LS_YEARS_KEY, String(selectedYears));
    }

    function loadYearsFromLocalStorage() {
        const v = localStorage.getItem(LS_YEARS_KEY);
        if (!v) return YEARS_DEFAULT;
        const n = parseInt(v, 10);
        return (Number.isFinite(n) && n >= 1 && n <= 100) ? n : YEARS_DEFAULT;
    }

    /* ===== å¹´æ•°ä¸‹æ‹‰åˆå§‹åŒ– ===== */
    function initYearsSelect() {
        const $sel = $('#yearsSelect');
        $sel.empty();
        for (let i = 1; i <= 100; i++) $sel.append(`<option value="${i}">${i}</option>`);
        selectedYears = loadYearsFromLocalStorage();
        $sel.val(String(selectedYears));
        updateYearsUI();

        $sel.on('change', () => {
            selectedYears = parseInt($sel.val(), 10) || YEARS_DEFAULT;
            saveYearsToLocalStorage();
            updateYearsUI();
            recomputeAll();
            updateCategoryChart(); // å¹´æ•°å˜åŒ–ä¸å½±å“å¹´å‡ï¼Œä½†ä¿æŒåŒæ­¥
        });
    }

    function updateYearsUI() {
        $('#yearsLabel').text(String(selectedYears));
        $('#yearsLabel2').text(String(selectedYears));
    }

    /* ===== CSV å¯¼å…¥/å¯¼å‡º ===== */
    function parseCSVLine(line) {
        const out = [];
        let cur = '', inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i], next = line[i + 1];
            if (inQuotes) {
                if (ch === '"' && next === '"') {
                    cur += '"';
                    i++;
                } else if (ch === '"') {
                    inQuotes = false;
                } else {
                    cur += ch;
                }
            } else {
                if (ch === '"') {
                    inQuotes = true;
                } else if (ch === ',') {
                    out.push(cur);
                    cur = '';
                } else {
                    cur += ch;
                }
            }
        }
        out.push(cur);
        return out;
    }

    function exportCSV() {
        const header = ["ç±»ç›®", "é¡¹ç›®", "å‘¨æœŸ", "æ”¯å‡º(Â¥)", "æ—¥å‡(Â¥)", "æœˆå‡(Â¥)", "å¹´å‡(Â¥)", "30å¹´(Â¥)", `${selectedYears}å¹´(Â¥)`];
        const lines = [header.join(',')];
        $('#tbody tr').each(function () {
            const tds = $(this).find('td');
            const row = [
                $(tds[0]).find('select').val(),
                (($(tds[1]).find('input').val() || '').replace(/,/g, ' ')),
                $(tds[2]).find('select').val(),
                parseNum($(tds[3]).find('input').val()),
                $(tds[4]).text().replace(/,/g, ''),
                $(tds[5]).text().replace(/,/g, ''),
                $(tds[6]).text().replace(/,/g, ''),
                $(tds[7]).text().replace(/,/g, ''),
                $(tds[8]).text().replace(/,/g, '')
            ];
            lines.push(row.join(','));
        });
        const sum = ["åˆè®¡", "", "",
            $('#sumD').text().replace(/,/g, ''),
            $('#sumE').text().replace(/,/g, ''),
            $('#sumF').text().replace(/,/g, ''),
            $('#sumG').text().replace(/,/g, ''),
            $('#sumH').text().replace(/,/g, ''),
            $('#sumI').text().replace(/,/g, '')];
        lines.push(sum.join(','));

        const blob = new Blob(['\ufeff' + lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'æ¶ˆè´¹ç›˜ç‚¹.csv';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function importCSVFromText(text) {
        if (!text) return;
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lines.length < 2) {
            alert('CSV å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
            return;
        }

        const header = parseCSVLine(lines[0]);
        let importedYears = selectedYears;
        const lastHeader = header[header.length - 1] || '';
        const yearsMatch = lastHeader.match(/(\d+)\s*å¹´/);
        if (yearsMatch) {
            const y = parseInt(yearsMatch[1], 10);
            if (Number.isFinite(y) && y >= 1 && y <= 100) importedYears = y;
        }
        if (header.length < 9) {
            alert('CSV åˆ—æ•°ä¸è¶³ï¼Œæ— æ³•å¯¼å…¥');
            return;
        }

        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const arr = parseCSVLine(lines[i]);
            if (!arr.length) continue;
            if ((arr[0] || '').trim() === 'åˆè®¡') break;

            const cat = (arr[0] || 'å…¶å®ƒ').trim() || 'å…¶å®ƒ';
            const name = (arr[1] || '').trim();
            const period = (arr[2] || 'æ¯æœˆ').trim();
            const amount = parseNum(arr[3]);

            rows.push({cat, name, period, amount});
        }
        if (!rows.length) {
            alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®è¡Œ');
            return;
        }

        selectedYears = importedYears;
        $('#yearsSelect').val(String(selectedYears));
        updateYearsUI();
        saveYearsToLocalStorage();

        mountRows(rows);
        saveToLocalStorage();
        updateCategoryChart(); // å›¾è¡¨è”åŠ¨
    }

    function bindImport() {
        const fileInput = document.getElementById('importFile');
        document.getElementById('importCSV').addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    importCSVFromText(String(e.target.result || ''));
                } catch (err) {
                    console.error(err);
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯');
                } finally {
                    fileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
                fileInput.value = '';
            };
            reader.readAsText(file, 'utf-8');
        });
    }

    /* ===== åˆ—æ˜¾ç¤ºæ§åˆ¶ ===== */
    function loadColsVisibility() {
        try {
            const json = localStorage.getItem(LS_COLS_KEY);
            if (!json) return {daily: true, monthly: true, yearly: true, y30: true, custom: true};
            const obj = JSON.parse(json);
            return {
                daily: obj.daily !== false,
                monthly: obj.monthly !== false,
                yearly: obj.yearly !== false,
                y30: obj.y30 !== false,
                custom: obj.custom !== false
            };
        } catch (_) {
            return {daily: true, monthly: true, yearly: true, y30: true, custom: true};
        }
    }

    function saveColsVisibility(state) {
        localStorage.setItem(LS_COLS_KEY, JSON.stringify(state));
    }

    function applyColsVisibility(state) {
        // é€åˆ—å¤„ç†ï¼šæ˜¾ç¤º=ç§»é™¤éšè—ç±»ï¼›éšè—=æ·»åŠ éšè—ç±»
        Object.entries(COLS).forEach(([key, sel]) => {
            const show = !!state[key];
            $(sel.th).toggleClass('col-hidden', !show);
            $(sel.tds).toggleClass('col-hidden', !show);
            $(sel.tf).toggleClass('col-hidden', !show);
        });
    }

    function bindColsToggles(state) {
        const map = {
            daily: '#toggleDaily',
            monthly: '#toggleMonthly',
            yearly: '#toggleYearly',
            y30: '#toggle30y',
            custom: '#toggleCustom'
        };
        // åˆå§‹åŒæ­¥å‹¾é€‰çŠ¶æ€
        Object.entries(map).forEach(([k, sel]) => {
            const el = document.querySelector(sel);
            if (el) el.checked = !!state[k];
        });
        // ç»‘å®šäº‹ä»¶
        Object.entries(map).forEach(([k, sel]) => {
            $(sel).on('change', function () {
                state[k] = this.checked;
                saveColsVisibility(state);
                applyColsVisibility(state);
            });
        });
    }

    /* ====== ç±»ç›®æ±‡æ€» & å›¾è¡¨ ====== */
    // ä¸â€œæˆªå›¾é£æ ¼â€ä¸€è‡´çš„æŸ”å’Œé…è‰²ï¼ˆå›ºå®šé¡ºåºï¼Œç±»ç›®ä¸è¶³ä¼šå¾ªç¯ä½¿ç”¨ï¼‰
    const PALETTE = [
        '#3b82f6', // è“
        '#10b981', // ç»¿
        '#f59e0b', // æ©™
        '#ef4444', // çº¢
        '#8b5cf6', // ç´«
        '#06b6d4', // é’
        '#f97316', // æ©˜
        '#64748b'  // ç°
    ];

    let categoryChart = null;

    function getAnnualForRow($tr) {
        // æ ¹æ®è¡Œæ•°æ®è®¡ç®—å¹´å‡é‡‘é¢ï¼ˆä¸è¡¨æ ¼ä¸€è‡´ï¼šæ—¥å‡Ã—365ï¼‰
        const amount = parseNum($tr.find('.input-amount').val());
        const period = $tr.find('.select-period').val() || 'æ¯æœˆ';
        const days = PERIOD_TO_DAYS[period] || 0;
        if (!days) return 0;
        const E = amount / days;
        const G = E * 365;
        return G;
    }

    function computeCategoryTotals() {
        // è¿”å› {cat: annualSum}
        const map = new Map();
        $('#tbody tr').each(function () {
            const $tr = $(this);
            const cat = ($tr.find('.input-cat').val() || 'å…¶å®ƒ');
            const annual = getAnnualForRow($tr);
            const prev = map.get(cat) || 0;
            map.set(cat, prev + annual);
        });
        return map;
    }

    function renderLegend(labels, colors, values, total) {
        const $legend = $('#categoryLegend');
        $legend.empty();
        if (total <= 0 || labels.length === 0) return;

        labels.forEach((lbl, idx) => {
            const val = values[idx] || 0;
            const pct = total > 0 ? (val / total * 100) : 0;
            const $item = $(`
                <div class="legend-item">
                    <div class="legend-left">
                        <span class="legend-box" style="background:${colors[idx]}"></span>
                        <span class="legend-label">${lbl}</span>
                    </div>
                    <div class="legend-right">
                        <span class="legend-amt">Â¥ ${val.toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}</span>
                        <span class="legend-pct">(${pct.toFixed(1)}%)</span>
                    </div>
                </div>
            `);
            $legend.append($item);
        });
    }

    function updateCategoryChart() {
        const totals = computeCategoryTotals();
        // ä»…ä¿ç•™ >0 çš„ç±»ç›®
        const labels = [];
        const data = [];
        totals.forEach((v, k) => {
            if (v > 0.000001) {
                labels.push(k);
                data.push(v);
            }
        });

        const total = data.reduce((a, b) => a + b, 0);
        const emptyEl = document.getElementById('chartEmpty');
        if (total <= 0) {
            // æ¸…ç©ºå›¾è¡¨å¹¶æ˜¾ç¤ºâ€œæš‚æ— æ•°æ®â€
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }
            emptyEl.classList.add('show');
            $('#categoryLegend').empty();
            return;
        } else {
            emptyEl.classList.remove('show');
        }

        // é¢œè‰²ï¼ˆæŒ‰ labels é¡ºåºè½®è¯¢ PALETTEï¼‰
        const colors = labels.map((_, i) => PALETTE[i % PALETTE.length]);

        // å›¾è¡¨é…ç½®
        const ctx = document.getElementById('categoryChart').getContext('2d');

        // é‡å»ºå›¾è¡¨ï¼ˆé¿å… dataset åŠ¨æ€å¢åˆ å¯¼è‡´çš„å¼•ç”¨é—®é¢˜ï¼‰
        if (categoryChart) {
            categoryChart.destroy();
        }
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '62%',
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const v = ctx.parsed || 0;
                                const p = total > 0 ? (v / total * 100) : 0;
                                return `${ctx.label}: Â¥ ${v.toLocaleString('zh-CN', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                })}  (${p.toFixed(1)}%)`;
                            }
                        }
                    }
                }
            }
        });

        // è‡ªå®šä¹‰å›¾ä¾‹
        renderLegend(labels, colors, data, total);
    }

    /* ===== åˆå§‹åŒ– ===== */
    function addRow(data) {
        $('#tbody').append(buildRow(data));
        updateMoveButtons();
    }

    function mountRows(rows) {
        $('#tbody').empty();
        rows.forEach(r => addRow(r));
        computeTotals();
        updateMoveButtons();

        // åº”ç”¨åˆ—éšè—åˆ°æ–°æ¸²æŸ“çš„è¡Œ
        applyColsVisibility(loadColsVisibility());

        // æ¸²æŸ“å›¾è¡¨
        updateCategoryChart();
    }

    $(function () {
        // åˆå§‹åŒ–â€œå¹´æ•°â€é€‰æ‹© & å¯¼å…¥ç»‘å®š
        initYearsSelect();
        bindImport();

        // è½½å…¥æœ¬åœ°æˆ–æ¨¡æ¿
        const saved = loadFromLocalStorage();
        mountRows(saved && saved.length ? saved : TEMPLATE_ROWS);

        // ç»‘å®šæŒ‰é’®
        $('#addRow').on('click', () => {
            addRow({cat: "å…¶å®ƒ", name: "", period: "æ¯æœˆ", amount: 0});
            saveToLocalStorage();
            // æ–°å¢è¡Œä¹Ÿè¦åº”ç”¨åˆ—éšè—
            applyColsVisibility(loadColsVisibility());
            updateCategoryChart(); // å›¾è¡¨è”åŠ¨
        });
        $('#restoreTemplate').on('click', () => {
            mountRows(TEMPLATE_ROWS);
            clearLocal();
            saveToLocalStorage();
            updateCategoryChart(); // å›¾è¡¨è”åŠ¨
        });
        $('#clearAll').on('click', () => {
            $('#tbody').empty();
            computeTotals();
            clearLocal();
            updateMoveButtons();
            updateCategoryChart(); // å›¾è¡¨è”åŠ¨
        });
        $('#exportCSV').on('click', exportCSV);

        // åˆ—æ˜¾ç¤ºæ§åˆ¶ï¼šåŠ è½½çŠ¶æ€ã€ç»‘å®šäº‹ä»¶ã€é¦–æ¬¡åº”ç”¨
        const colState = loadColsVisibility();
        bindColsToggles(colState);
        applyColsVisibility(colState);
    });
</script>
</body>
</html>
