<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <link rel="icon" href="dist/favicon/expense.ico"/>
    <title>æ¶ˆè´¹ç›˜ç‚¹</title>
    <!-- Bootstrap & jQueryï¼ˆä¸ç°é¡µä¸€è‡´çš„æŠ€æœ¯æ ˆï¼‰ -->
    <link rel="stylesheet" type="text/css" href="dist/css/c070423032508.css">
    <link rel="stylesheet" type="text/css" href="dist/css/c220423282110.css">
    <link rel="stylesheet" href="dist/css/bootstrap.min.css">
    <script src="dist/js/jquery-3.7.0.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <script src="dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: #fff;
            padding-bottom: 60px;
        }

        .page-title {
            font-weight: 700;
            letter-spacing: .5px;
        }

        .th-info {
            color: #6c757d;
            font-weight: 400;
            font-size: .85rem;
        }

        .card-soft {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: .75rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .03);
        }

        .table thead th {
            white-space: nowrap;
            vertical-align: bottom;
            position: sticky;
            top: 0;
            z-index: 2;
            background: #212529;
            color: #fff;
            border-color: #212529;
        }

        .table td, .table th {
            vertical-align: middle;
        }

        .num {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .muted {
            color: #6c757d;
        }

        .tfoot-total td {
            font-weight: 800;
            font-size: 1.05rem;
            background: #fcfcfd;
            border-top: 2px solid #343a40;
        }

        .btn-black {
            background: #000;
            color: #fff;
        }

        .btn-black:hover {
            color: #fff;
            filter: brightness(1.1);
        }

        .tag {
            padding: .2rem .4rem;
            border-radius: .35rem;
            background: #f1f3f5;
            font-size: .8rem;
        }

        .table-responsive, .table {
            width: 100%;
        }

        .bottom-navigation {
            z-index: 1000;
        }

        .btn-ops-group .btn {
            margin: 0 .15rem;
        }

        .col-hidden {
            display: none !important;
        }

        /* ====== å›¾è¡¨åŒºåŸŸæ ·å¼ï¼ˆä¸ç°æœ‰é£æ ¼ç»Ÿä¸€ï¼Œå¢å¼ºç¾åŒ–ï¼‰ ====== */
        .chart-wrap {
            position: relative;
            min-height: 260px;
        }

        .chart-empty {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: .95rem;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px dashed #e9ecef;
            border-radius: .75rem;
        }

        .chart-empty.show {
            display: flex;
        }

        .legend {
            line-height: 1.2;
        }

        .legend .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #e9ecef;
            border-radius: .5rem;
            padding: .5rem .65rem;
            background: #fff;
            margin-bottom: .5rem;
            transition: all .15s ease;
            cursor: pointer;
        }

        .legend .legend-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
            transform: translateY(-1px);
        }

        .legend .legend-item.off {
            opacity: .45;
        }

        .legend .legend-left {
            display: flex;
            align-items: center;
            min-width: 0;
        }

        .legend .legend-box {
            width: 14px;
            height: 14px;
            border: 1px solid #ced4da;
            margin-right: 8px;
            border-radius: 3px;
        }

        .legend .legend-label {
            font-weight: 600;
            color: #212529;
            white-space: nowrap;
        }

        .legend .legend-right {
            text-align: right;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            margin-left: 8px;
        }

        .legend .legend-amt {
            color: #212529;
        }

        .legend .legend-pct {
            color: #6c757d;
            margin-left: 6px;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4 px-3">
    <div class="d-flex align-items-center mb-3">
        <h2 class="page-title mb-0">æ¶ˆè´¹ç›˜ç‚¹</h2>
        <div class="ml-3 tag">æ—¥å‡ / æœˆå‡ / å¹´å‡ / 30å¹´ / <span id="yearsLabel">--</span>å¹´</div>
    </div>

    <!-- ===== ä¼˜åŒ–ç¾åŒ–åçš„ç±»ç›®æ¶ˆè´¹å æ¯”ï¼ˆåœ†ç¯å›¾ï¼‰ ===== -->
    <div class="card-soft p-3 mb-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 mr-2">ç±»ç›®æ¶ˆè´¹å æ¯”</h5>
                <span class="th-info">ï¼ˆå¹´å‡ï¼‰</span>
            </div>
            <div id="chartSummary" class="small text-muted">â€”</div>
        </div>
        <div class="row align-items-center">
            <div class="col-md-7">
                <div class="chart-wrap p-2">
                    <canvas id="categoryChart" height="200"></canvas>
                    <div id="chartEmpty" class="chart-empty">æš‚æ— æ•°æ®</div>
                </div>
            </div>
            <div class="col-md-5">
                <div id="categoryLegend" class="legend small"></div>
            </div>
        </div>
    </div>

    <!-- æ§ä»¶åŒº -->
    <div class="card-soft p-3 mb-3">
        <div class="d-flex flex-wrap align-items-center">
            <div class="mr-2 mb-2">
                <button id="addRow" class="btn btn-outline-secondary">ï¼‹ æ·»åŠ </button>
            </div>
            <div class="mr-2 mb-2">
                <button id="restoreTemplate" class="btn btn-outline-secondary">â†º é‡ç½®</button>
            </div>
            <div class="mr-2 mb-2">
                <button id="clearAll" class="btn btn-outline-secondary">ğŸ—‘ æ¸…ç©º</button>
            </div>

            <!-- å¯¼å…¥/å¯¼å‡º -->
            <div class="mr-2 mb-2">
                <button id="importCSV" class="btn btn-outline-primary">â¤’ å¯¼å…¥ CSV</button>
                <input id="importFile" type="file" accept=".csv,text/csv" class="d-none"/>
            </div>
            <div class="mr-2 mb-2">
                <button id="exportCSV" class="btn btn-black">â¤“ å¯¼å‡º CSV</button>
            </div>
        </div>

        <!-- æ˜¾ç¤ºåˆ—æ§åˆ¶ -->
        <div class="mt-2">
            <div class="small text-muted mb-1">æ˜¾ç¤º/éšè—åˆ—</div>
            <div class="d-flex flex-wrap align-items-center">
                <label class="mr-3 mb-2"><input type="checkbox" id="toggleDaily" checked> æ—¥å‡</label>
                <label class="mr-3 mb-2"><input type="checkbox" id="toggleMonthly" checked> æœˆå‡</label>
                <label class="mr-3 mb-2"><input type="checkbox" id="toggleYearly" checked> å¹´å‡</label>
                <label class="mr-3 mb-2"><input type="checkbox" id="toggle30y" checked> 30å¹´</label>
                <label class="mr-3 mb-2 d-flex align-items-center">
                    <input type="checkbox" id="toggleCustom" checked><span class="ml-1" id="yearsLabel2">è‡ªå®šä¹‰</span>å¹´
                </label>
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-responsive">
        <table id="expenseTable" class="table table-hover table-bordered mb-0">
            <thead class="thead-dark">
            <tr>
                <th style="min-width:90px;">ç±»ç›®</th>
                <th style="min-width:180px;">é¡¹ç›®</th>
                <th style="min-width:100px;">å‘¨æœŸ</th>
                <th class="num">æ”¯å‡ºÂ¥</th>
                <th class="num th-daily">æ—¥å‡Â¥</th>
                <th class="num th-monthly">æœˆå‡Â¥</th>
                <th class="num th-yearly">å¹´å‡Â¥</th>
                <th class="num th-30y">30å¹´Â¥</th>
                <th class="num th-custom">
                    <div class="d-flex align-items-center justify-content-center">
                        <select id="yearsSelect" class="custom-select custom-select-sm w-auto"></select>
                        <span class="ml-1">Â¥</span>
                    </div>
                </th>
                <th class="text-center" style="min-width:90px;">æ“ä½œ</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
            <tfoot>
            <tr class="tfoot-total">
                <td colspan="3" class="text-right">åˆè®¡</td>
                <td class="num" id="sumD">0.00</td>
                <td class="num tfoot-daily" id="sumE">0.00</td>
                <td class="num tfoot-monthly" id="sumF">0.00</td>
                <td class="num tfoot-yearly" id="sumG">0.00</td>
                <td class="num tfoot-30y" id="sumH">0.00</td>
                <td class="num tfoot-custom" id="sumI">0.00</td>
                <td></td>
            </tr>
            </tfoot>
        </table>
    </div>

    <div class="small text-muted mt-2">
        å‘¨æœŸå¤©æ•°æ˜ å°„ï¼šæ¯å¤©=1ï¼Œ æ¯å‘¨=7ï¼Œ æ¯æœˆ=30ï¼Œ æ¯å¹´=365ï¼Œ æ¯2å¹´=730...
    </div>
</div>

<div class="bottom-navigation">
    <a href="index.html">ğŸ’° FIREè®¡ç®—å™¨</a>
    <a href="life.html">â° ç”Ÿå‘½å€’è®¡æ—¶</a>
    <a href="expense.html">ğŸ§¾ æ¶ˆè´¹ç›˜ç‚¹</a>
    <a href="rental.html">ğŸ  æˆ¿äº§ç§Ÿå”®æ¯”</a>
</div>

<script src="dist/chart.min.js"></script>

<script>
    /* ===== é…ç½® ===== */
    const PERIOD_OPTIONS = [
        "æ¯å¤©", "æ¯å‘¨", "æ¯æœˆ", "æ¯å¹´",
        "æ¯2å¹´", "æ¯3å¹´", "æ¯4å¹´", "æ¯5å¹´", "æ¯6å¹´", "æ¯7å¹´", "æ¯8å¹´", "æ¯9å¹´", "æ¯10å¹´"
    ];
    const PERIOD_TO_DAYS = {
        "æ¯å¤©": 1, "æ¯å‘¨": 7, "æ¯æœˆ": 30, "æ¯å¹´": 365,
        "æ¯2å¹´": 2 * 365, "æ¯3å¹´": 3 * 365, "æ¯4å¹´": 4 * 365, "æ¯5å¹´": 5 * 365,
        "æ¯6å¹´": 6 * 365, "æ¯7å¹´": 7 * 365, "æ¯8å¹´": 8 * 365, "æ¯9å¹´": 9 * 365, "æ¯10å¹´": 10 * 365
    };
    const CATEGORY_OPTIONS = ["é¥®é£Ÿ", "å¨±ä¹", "ç”µå­", "ç”Ÿæ´»", "å®¶ç”µ", "äº¤é€š", "æ—…æ¸¸", "å® ç‰©", "å…¶å®ƒ"];

    const YEARS_DEFAULT = 40;
    const LS_KEY = 'expense_rows_v1';
    const LS_YEARS_KEY = 'expense_years_v1';
    const LS_COLS_KEY = 'expense_cols_visibility_v1';

    const COLS = {
        daily: {th: '.th-daily', tds: 'td.cell-daily', tf: 'td.tfoot-daily'},
        monthly: {th: '.th-monthly', tds: 'td.cell-monthly', tf: 'td.tfoot-monthly'},
        yearly: {th: '.th-yearly', tds: 'td.cell-yearly', tf: 'td.tfoot-yearly'},
        y30: {th: '.th-30y', tds: 'td.cell-30y', tf: 'td.tfoot-30y'},
        custom: {th: '.th-custom', tds: 'td.cell-custom-y', tf: 'td.tfoot-custom'}
    };

    let selectedYears = YEARS_DEFAULT;

    /* ç¤ºä¾‹æ¨¡æ¿ */
    const TEMPLATE_ROWS = [
        {cat: "é¥®é£Ÿ", name: "æ—©é¤", period: "æ¯å¤©", amount: 5},
        {cat: "é¥®é£Ÿ", name: "ä¸­é¤(è‡ªå·±åš)", period: "æ¯å¤©", amount: 18},
        {cat: "é¥®é£Ÿ", name: "æ™šé¤(é¸¡è›‹/ç‰›å¥¶/ç‰ç±³ç­‰)", period: "æ¯å¤©", amount: 5},
        {cat: "é¥®é£Ÿ", name: "æ°´æœ", period: "æ¯æœˆ", amount: 200},
        {cat: "é¥®é£Ÿ", name: "å¤§é¤", period: "æ¯æœˆ", amount: 200},
        {cat: "å¨±ä¹", name: "ç”µå½±ç¥¨(æ¯æœˆ2~3å¼ )", period: "æ¯æœˆ", amount: 200},
        {cat: "ç”µå­", name: "æ‰‹æœº", period: "æ¯3å¹´", amount: 3000},
        {cat: "ç”µå­", name: "é«˜ç«¯ç”µè„‘", period: "æ¯4å¹´", amount: 8000},
        {cat: "ç”µå­", name: "å¤–è®¾(æ˜¾ç¤ºå™¨/éŸ³ç®±/å¹³æ¿ç­‰)", period: "æ¯4å¹´", amount: 5000},
        {cat: "ç”Ÿæ´»", name: "è¯è´¹+ç½‘è´¹(ç”µä¿¡1000M)", period: "æ¯æœˆ", amount: 199},
        {cat: "ç”Ÿæ´»", name: "è¿åŠ¨å™¨æ¢°(å«æŸåæ›´æ¢)", period: "æ¯å¹´", amount: 1000},
        {cat: "ç”Ÿæ´»", name: "æ°´ç”µç‡ƒæ°”", period: "æ¯å¹´", amount: 3000},
        {cat: "ç”Ÿæ´»", name: "ç‰©ä¸šè´¹(å«æŸè€—ç»´æŠ¤)", period: "æ¯å¹´", amount: 1500},
        {cat: "å®¶ç”µ", name: "å†°ç®±", period: "æ¯5å¹´", amount: 1500},
        {cat: "å®¶ç”µ", name: "æ´—è¡£æœº", period: "æ¯5å¹´", amount: 2000},
        {cat: "å®¶ç”µ", name: "çƒ˜å¹²æœº", period: "æ¯5å¹´", amount: 2000},
        {cat: "å®¶ç”µ", name: "ç©ºè°ƒ", period: "æ¯5å¹´", amount: 2000},
        {cat: "äº¤é€š", name: "äº¤é€šè´¹(å¸‚åŸŸåœ°é“)", period: "æ¯æœˆ", amount: 40},
        {cat: "äº¤é€š", name: "äº¤é€šè´¹(åŸé™…é«˜é“)", period: "æ¯å¹´", amount: 1000},
        {cat: "äº¤é€š", name: "äº¤é€šè´¹(å°ç”µé©´åŠå……ç”µ)", period: "æ¯3å¹´", amount: 3000},
        {cat: "å…¶å®ƒ", name: "è¡£ç‰©/æ—¥ç”¨/åŒ»ç–—/äººæƒ…/å­¦ä¹ â€¦", period: "æ¯å¹´", amount: 1000}
    ];

    /* ===== å·¥å…·å‡½æ•° ===== */
    const fmt = n => Number(n || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const fmtPlain = n => (Number(n || 0)).toFixed(2);
    const parseNum = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    function calcByDays(amount, days) {
        if (!days) return {E: 0, F: 0, G: 0, H: 0, I: 0};
        const E = amount / days;
        const F = E * 30;
        const G = E * 365;
        const H = G * 30;
        const I = G * selectedYears;
        return {E, F, G, H, I};
    }

    function buildSelect(options, selected) {
        const $sel = $('<select class="form-control form-control-sm"></select>');
        options.forEach(opt => $sel.append(`<option ${opt === selected ? 'selected' : ''}>${opt}</option>`));
        return $sel;
    }

    function buildRow(data = {cat: "å…¶å®ƒ", name: "", period: "æ¯æœˆ", amount: 0}) {
        const $tr = $('<tr></tr>');
        const $cat = buildSelect(CATEGORY_OPTIONS, data.cat).addClass('input-cat');
        const $name = $(`<input type="text" class="form-control form-control-sm input-name" placeholder="">`).val(data.name);
        const $period = buildSelect(PERIOD_OPTIONS, data.period).addClass('select-period');
        const $amount = $(`<input type="number" class="form-control form-control-sm input-amount num" step="1" min="0">`).val(data.amount);

        const $tdCat = $('<td></td>').append($cat);
        const $tdName = $('<td></td>').append($name);
        const $tdPer = $('<td></td>').append($period);
        const $tdAmt = $('<td class="num"></td>').append($amount);
        const $tdE = $('<td class="num cell-daily">0.00</td>');
        const $tdF = $('<td class="num cell-monthly">0.00</td>');
        const $tdG = $('<td class="num cell-yearly">0.00</td>');
        const $tdH = $('<td class="num cell-30y">0.00</td>');
        const $tdI = $('<td class="num cell-custom-y">0.00</td>');

        const $btnUp = $('<button class="btn btn-sm btn-outline-secondary btn-move-up" title="ä¸Šç§»">â†‘</button>');
        const $btnDown = $('<button class="btn btn-sm btn-outline-secondary btn-move-down" title="ä¸‹ç§»">â†“</button>');
        const $btnDel = $('<button class="btn btn-sm btn-outline-danger btn-del" title="åˆ é™¤">Ã—</button>');
        const $opsWrap = $('<div class="btn-ops-group d-inline-flex align-items-center"></div>').append($btnUp, $btnDown, $btnDel);
        const $tdOps = $('<td class="text-center"></td>').append($opsWrap);

        $tr.append($tdCat, $tdName, $tdPer, $tdAmt, $tdE, $tdF, $tdG, $tdH, $tdI, $tdOps);

        $tr.on('input change', '.input-amount, .select-period, .input-name, .input-cat', () => {
            computeRow($tr);
            computeTotals();
            saveToLocalStorage();
            updateCategoryChart();
        });
        $tr.on('click', '.btn-del', () => {
            $tr.remove();
            computeTotals();
            saveToLocalStorage();
            updateMoveButtons();
            updateCategoryChart();
        });
        $tr.on('click', '.btn-move-up', () => {
            const $p = $tr.prev('tr');
            if ($p.length) {
                $tr.insertBefore($p);
                computeTotals();
                saveToLocalStorage();
                updateMoveButtons();
                updateCategoryChart();
            }
        });
        $tr.on('click', '.btn-move-down', () => {
            const $n = $tr.next('tr');
            if ($n.length) {
                $tr.insertAfter($n);
                computeTotals();
                saveToLocalStorage();
                updateMoveButtons();
                updateCategoryChart();
            }
        });

        computeRow($tr);
        return $tr;
    }

    function updateMoveButtons() {
        const $rows = $('#tbody tr');
        $rows.find('.btn-move-up, .btn-move-down').prop('disabled', false);
        if ($rows.length === 0) return;
        $rows.first().find('.btn-move-up').prop('disabled', true);
        $rows.last().find('.btn-move-down').prop('disabled', true);
    }

    function computeRow($tr) {
        const amount = parseNum($tr.find('.input-amount').val());
        const period = $tr.find('.select-period').val();
        const days = PERIOD_TO_DAYS[period] || 0;
        const {E, F, G, H, I} = calcByDays(amount, days);
        $tr.find('.cell-daily').text(fmt(E));
        $tr.find('.cell-monthly').text(fmt(F));
        $tr.find('.cell-yearly').text(fmt(G));
        $tr.find('.cell-30y').text(fmt(H));
        $tr.find('.cell-custom-y').text(fmt(I));
    }

    function computeTotals() {
        let sumD = 0, sumE = 0, sumF = 0, sumG = 0, sumH = 0, sumI = 0;
        $('#tbody tr').each(function () {
            const $tr = $(this);
            const amount = parseNum($tr.find('.input-amount').val());
            const e = parseNum($tr.find('.cell-daily').text().replace(/,/g, ''));
            const f = parseNum($tr.find('.cell-monthly').text().replace(/,/g, ''));
            const g = parseNum($tr.find('.cell-yearly').text().replace(/,/g, ''));
            const h = parseNum($tr.find('.cell-30y').text().replace(/,/g, ''));
            const i = parseNum($tr.find('.cell-custom-y').text().replace(/,/g, ''));
            sumD += amount;
            sumE += e;
            sumF += f;
            sumG += g;
            sumH += h;
            sumI += i;
        });
        $('#sumD').text(fmtPlain(sumD));
        $('#sumE').text(fmtPlain(sumE));
        $('#sumF').text(fmtPlain(sumF));
        $('#sumG').text(fmtPlain(sumG));
        $('#sumH').text(fmtPlain(sumH));
        $('#sumI').text(fmtPlain(sumI));
        document.getElementById('chartSummary').textContent =
            'å¹´å‡åˆè®¡ï¼šÂ¥ ' + Number(sumG || 0).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
    }

    function recomputeAll() {
        $('#tbody tr').each(function () {
            computeRow($(this));
        });
        computeTotals();
        updateMoveButtons();
    }

    /* ===== LocalStorageï¼ˆè¡Œæ•°æ®/å¹´æ•°/åˆ—æ˜¾ç¤ºï¼‰ ===== */
    function saveToLocalStorage() {
        const rows = [];
        $('#tbody tr').each(function () {
            rows.push({
                cat: $(this).find('.input-cat').val(),
                name: $(this).find('.input-name').val(),
                period: $(this).find('.select-period').val(),
                amount: parseNum($(this).find('.input-amount').val())
            });
        });
        localStorage.setItem(LS_KEY, JSON.stringify(rows));
    }

    function loadFromLocalStorage() {
        try {
            const json = localStorage.getItem(LS_KEY);
            if (!json) return null;
            const rows = JSON.parse(json);
            return Array.isArray(rows) ? rows : null;
        } catch (e) {
            return null;
        }
    }

    function clearLocal() {
        localStorage.removeItem(LS_KEY);
    }

    function saveYearsToLocalStorage() {
        localStorage.setItem(LS_YEARS_KEY, String(selectedYears));
    }

    function loadYearsFromLocalStorage() {
        const v = localStorage.getItem(LS_YEARS_KEY);
        if (!v) return YEARS_DEFAULT;
        const n = parseInt(v, 10);
        return (Number.isFinite(n) && n >= 1 && n <= 100) ? n : YEARS_DEFAULT;
    }

    function initYearsSelect() {
        const $sel = $('#yearsSelect');
        $sel.empty();
        for (let i = 1; i <= 100; i++) $sel.append(`<option value="${i}">${i}</option>`);
        selectedYears = loadYearsFromLocalStorage();
        $sel.val(String(selectedYears));
        updateYearsUI();
        $sel.on('change', () => {
            selectedYears = parseInt($sel.val(), 10) || YEARS_DEFAULT;
            saveYearsToLocalStorage();
            updateYearsUI();
            recomputeAll();
            updateCategoryChart();
        });
    }

    function updateYearsUI() {
        $('#yearsLabel').text(String(selectedYears));
        $('#yearsLabel2').text(String(selectedYears));
    }

    /* ===== CSV ===== */
    function parseCSVLine(line) {
        const out = [];
        let cur = '', inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i], next = line[i + 1];
            if (inQuotes) {
                if (ch === '"' && next === '"') {
                    cur += '"';
                    i++;
                } else if (ch === '"') {
                    inQuotes = false;
                } else {
                    cur += ch;
                }
            } else {
                if (ch === '"') {
                    inQuotes = true;
                } else if (ch === ',') {
                    out.push(cur);
                    cur = '';
                } else {
                    cur += ch;
                }
            }
        }
        out.push(cur);
        return out;
    }

    function exportCSV() {
        const header = ["ç±»ç›®", "é¡¹ç›®", "å‘¨æœŸ", "æ”¯å‡º(Â¥)", "æ—¥å‡(Â¥)", "æœˆå‡(Â¥)", "å¹´å‡(Â¥)", "30å¹´(Â¥)", `${selectedYears}å¹´(Â¥)`];
        const lines = [header.join(',')];
        $('#tbody tr').each(function () {
            const tds = $(this).find('td');
            const row = [
                $(tds[0]).find('select').val(),
                (($(tds[1]).find('input').val() || '').replace(/,/g, ' ')),
                $(tds[2]).find('select').val(),
                parseNum($(tds[3]).find('input').val()),
                $(tds[4]).text().replace(/,/g, ''),
                $(tds[5]).text().replace(/,/g, ''),
                $(tds[6]).text().replace(/,/g, ''),
                $(tds[7]).text().replace(/,/g, ''),
                $(tds[8]).text().replace(/,/g, '')
            ];
            lines.push(row.join(','));
        });
        const sum = ["åˆè®¡", "", "",
            $('#sumD').text().replace(/,/g, ''),
            $('#sumE').text().replace(/,/g, ''),
            $('#sumF').text().replace(/,/g, ''),
            $('#sumG').text().replace(/,/g, ''),
            $('#sumH').text().replace(/,/g, ''),
            $('#sumI').text().replace(/,/g, '')
        ];
        lines.push(sum.join(','));

        const blob = new Blob(['\ufeff' + lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'æ¶ˆè´¹ç›˜ç‚¹.csv';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function importCSVFromText(text) {
        if (!text) return;
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lines.length < 2) {
            alert('CSV å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
            return;
        }

        const header = parseCSVLine(lines[0]);
        let importedYears = selectedYears;
        const lastHeader = header[header.length - 1] || '';
        const yearsMatch = lastHeader.match(/(\d+)\s*å¹´/);
        if (yearsMatch) {
            const y = parseInt(yearsMatch[1], 10);
            if (Number.isFinite(y) && y >= 1 && y <= 100) importedYears = y;
        }
        if (header.length < 9) {
            alert('CSV åˆ—æ•°ä¸è¶³ï¼Œæ— æ³•å¯¼å…¥');
            return;
        }

        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const arr = parseCSVLine(lines[i]);
            if (!arr.length) continue;
            if ((arr[0] || '').trim() === 'åˆè®¡') break;
            const cat = (arr[0] || 'å…¶å®ƒ').trim() || 'å…¶å®ƒ';
            const name = (arr[1] || '').trim();
            const period = (arr[2] || 'æ¯æœˆ').trim();
            const amount = parseNum(arr[3]);
            rows.push({cat, name, period, amount});
        }
        if (!rows.length) {
            alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®è¡Œ');
            return;
        }

        selectedYears = importedYears;
        $('#yearsSelect').val(String(selectedYears));
        updateYearsUI();
        saveYearsToLocalStorage();
        mountRows(rows);
        saveToLocalStorage();
        updateCategoryChart();
    }

    function bindImport() {
        const fileInput = document.getElementById('importFile');
        document.getElementById('importCSV').addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    importCSVFromText(String(e.target.result || ''));
                } catch (err) {
                    console.error(err);
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯');
                } finally {
                    fileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
                fileInput.value = '';
            };
            reader.readAsText(file, 'utf-8');
        });
    }

    function loadColsVisibility() {
        try {
            const json = localStorage.getItem(LS_COLS_KEY);
            if (!json) return {daily: true, monthly: true, yearly: true, y30: true, custom: true};
            const obj = JSON.parse(json);
            return {
                daily: obj.daily !== false, monthly: obj.monthly !== false,
                yearly: obj.yearly !== false, y30: obj.y30 !== false, custom: obj.custom !== false
            };
        } catch (_) {
            return {daily: true, monthly: true, yearly: true, y30: true, custom: true};
        }
    }

    function saveColsVisibility(state) {
        localStorage.setItem(LS_COLS_KEY, JSON.stringify(state));
    }

    function applyColsVisibility(state) {
        Object.entries(COLS).forEach(([key, sel]) => {
            const show = !!state[key];
            $(sel.th).toggleClass('col-hidden', !show);
            $(sel.tds).toggleClass('col-hidden', !show);
            $(sel.tf).toggleClass('col-hidden', !show);
        });
    }

    function bindColsToggles(state) {
        const map = {
            daily: '#toggleDaily', monthly: '#toggleMonthly',
            yearly: '#toggleYearly', y30: '#toggle30y', custom: '#toggleCustom'
        };
        Object.entries(map).forEach(([k, sel]) => {
            const el = document.querySelector(sel);
            if (el) el.checked = !!state[k];
        });
        Object.entries(map).forEach(([k, sel]) => {
            $(sel).on('change', function () {
                state[k] = this.checked;
                saveColsVisibility(state);
                applyColsVisibility(state);
            });
        });
    }

    /* ====== ç±»ç›®æ±‡æ€» & å›¾è¡¨ï¼ˆä¼˜åŒ–ç¾åŒ–ï¼‰ ====== */
    // é¢œè‰²ç”Ÿæˆï¼ˆæ›´å¹³æ»‘ã€åŒºåˆ†åº¦é«˜ï¼‰
    function genPalette(n) {
        const arr = [];
        for (let i = 0; i < n; i++) {
            const h = (i * (360 / Math.max(6, n))) % 360;
            const s = 70;
            const l = 55;
            arr.push(`hsl(${h} ${s}% ${l}%)`);
        }
        return arr;
    }

    let categoryChart = null;

    function getAnnualForRow($tr) {
        const amount = parseNum($tr.find('.input-amount').val());
        const period = $tr.find('.select-period').val() || 'æ¯æœˆ';
        const days = PERIOD_TO_DAYS[period] || 0;
        if (!days) return 0;
        const E = amount / days;
        return E * 365; // å¹´å‡
    }

    function computeCategoryTotals() {
        const map = new Map();
        $('#tbody tr').each(function () {
            const $tr = $(this);
            const cat = ($tr.find('.input-cat').val() || 'å…¶å®ƒ');
            const annual = getAnnualForRow($tr);
            map.set(cat, (map.get(cat) || 0) + annual);
        });
        return map;
    }

    // ä¸­å¿ƒæ–‡æœ¬æ’ä»¶ï¼ˆæ˜¾ç¤ºâ€œå¹´å‡åˆè®¡â€æˆ–æ‚¬æµ®åˆ†ç±»é‡‘é¢ï¼‰
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart, args, opts) {
            const {ctx, chartArea, _active} = chart;
            if (!chartArea) return;
            const labels = chart.data.labels || [];
            const data = (chart.data.datasets[0] && chart.data.datasets[0].data) || [];

            // å¯è§æ€»é¢
            let totalVisible = 0;
            data.forEach((v, i) => {
                if (chart.getDataVisibility(i)) totalVisible += +v;
            });

            // æ‚¬æµ®çŠ¶æ€
            const hoverIndex = chart.$center?.hoverIndex ?? null;
            const showHover = hoverIndex != null && chart.getDataVisibility(hoverIndex);
            const amount = showHover ? data[hoverIndex] : totalVisible;

            const centerX = (chartArea.left + chartArea.right) / 2;
            const centerY = (chartArea.top + chartArea.bottom) / 2;

            // åŠ¨æ€å­—å·ï¼ˆéšå†…åŠå¾„ï¼‰
            const meta = chart.getDatasetMeta(0);
            const inner = meta?.data?.[0]?.innerRadius || 80;
            const big = Math.max(16, Math.min(28, inner / 2.6));
            const small = Math.max(10, Math.min(14, inner / 6));

            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#0f172a';

            // ç¬¬ä¸€è¡Œï¼šé‡‘é¢
            ctx.font = `600 ${big}px ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue"`;
            const amtStr = 'Â¥ ' + Number(amount || 0).toLocaleString('zh-CN', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            ctx.fillText(amtStr, centerX, centerY - small);

            // ç¬¬äºŒè¡Œï¼šè¯´æ˜
            ctx.fillStyle = '#6b7280';
            ctx.font = `500 ${small}px ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue"`;
            if (showHover) {
                let visibleTotal = 0;
                data.forEach((v, i) => {
                    if (chart.getDataVisibility(i)) visibleTotal += +v;
                });
                const pct = visibleTotal > 0 ? (amount / visibleTotal * 100) : 0;
                const line2 = `${labels[hoverIndex] || ''} Â· ${pct.toFixed(1)}%`;
                ctx.fillText(line2, centerX, centerY + small * 1.4);
            } else {
                ctx.fillText('å¹´å‡åˆè®¡', centerX, centerY + small * 1.4);
            }
            ctx.restore();
        }
    };
    Chart.register(centerTextPlugin);

    // æ„å»º/åˆ·æ–° Legendï¼ˆå¯ç‚¹å‡»éšè—/æ˜¾ç¤ºåˆ†ç±»ï¼‰
    function buildLegend(chart) {
        const $legend = $('#categoryLegend');
        $legend.empty();
        const labels = chart.data.labels || [];
        const data = (chart.data.datasets[0] && chart.data.datasets[0].data) || [];
        const colors = (chart.data.datasets[0] && chart.data.datasets[0].backgroundColor) || [];

        let visibleTotal = 0;
        data.forEach((v, i) => {
            if (chart.getDataVisibility(i)) visibleTotal += +v;
        });

        labels.forEach((lbl, idx) => {
            const visible = chart.getDataVisibility(idx);
            const val = data[idx] || 0;
            const pct = visibleTotal > 0 ? (val / visibleTotal * 100) : 0;

            const $item = $(`
                <div class="legend-item ${visible ? '' : 'off'}" data-idx="${idx}">
                    <div class="legend-left">
                        <span class="legend-box" style="background:${colors[idx]}"></span>
                        <span class="legend-label">${lbl}</span>
                    </div>
                    <div class="legend-right">
                        <span class="legend-amt">Â¥ ${val.toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}</span>
                        <span class="legend-pct">(${visible ? pct.toFixed(1) : 0.0}%)</span>
                    </div>
                </div>
            `);
            $item.on('click', function () {
                const i = Number($(this).attr('data-idx'));
                chart.toggleDataVisibility(i);
                chart.update();
                // é‡å»º legend & æ›´æ–°æ‘˜è¦
                buildLegend(chart);
                updateChartSummaryFromChart(chart);
            });
            $legend.append($item);
        });
    }

    function updateChartSummaryFromChart(chart) {
        const data = (chart.data.datasets[0] && chart.data.datasets[0].data) || [];
        let visibleTotal = 0;
        data.forEach((v, i) => {
            if (chart.getDataVisibility(i)) visibleTotal += +v;
        });
        document.getElementById('chartSummary').textContent =
            'å¹´å‡åˆè®¡ï¼šÂ¥ ' + Number(visibleTotal || 0).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
    }

    function renderOrUpdateChart(labels, data) {
        const total = data.reduce((a, b) => a + b, 0);
        const emptyEl = document.getElementById('chartEmpty');

        if (total <= 0) {
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }
            emptyEl.classList.add('show');
            $('#categoryLegend').empty();
            return;
        } else {
            emptyEl.classList.remove('show');
        }

        const colors = genPalette(labels.length);

        if (!categoryChart) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        borderAlign: 'inner',
                        hoverOffset: 8,
                        spacing: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '62%',
                    layout: {padding: {top: 8, bottom: 8, left: 8, right: 8}},
                    animation: {duration: 800, easing: 'easeOutQuart'},
                    elements: {arc: {borderRadius: 8}},
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const v = ctx.parsed || 0;
                                    const all = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const visAll = ctx.chart.data.datasets[0].data
                                        .reduce((acc, val, i) => acc + (ctx.chart.getDataVisibility(i) ? +val : 0), 0);
                                    const pct = visAll > 0 ? (v / visAll * 100) : (all > 0 ? (v / all * 100) : 0);
                                    return `${ctx.label}: Â¥ ${v.toLocaleString('zh-CN', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}  (${pct.toFixed(1)}%)`;
                                }
                            },
                            backgroundColor: 'rgba(17,24,39,.95)',
                            titleColor: '#fff',
                            bodyColor: '#e5e7eb',
                            padding: 10,
                            displayColors: false
                        }
                    },
                    onHover: (evt, activeEls) => {
                        if (!categoryChart) return;
                        categoryChart.$center = categoryChart.$center || {};
                        categoryChart.$center.hoverIndex = activeEls && activeEls[0] ? activeEls[0].index : null;
                        categoryChart.draw();
                    }
                }
            });
        } else {
            // æ›´æ–°æ•°æ®è€Œéé”€æ¯é‡å»ºï¼Œé¿å…é—ªçƒ
            categoryChart.data.labels = labels;
            categoryChart.data.datasets[0].data = data;
            categoryChart.data.datasets[0].backgroundColor = colors;
            // é‡ç½®æ‰€æœ‰åˆ‡ç‰‡ä¸ºå¯è§ï¼ˆå½“æ•°æ®é¡ºåºå˜åŒ–æ—¶æ›´ç›´è§‚ï¼‰
            labels.forEach((_, i) => {
                if (!categoryChart.getDataVisibility(i)) categoryChart.toggleDataVisibility(i);
            });
            categoryChart.update();
        }

        buildLegend(categoryChart);
        updateChartSummaryFromChart(categoryChart);
    }

    function updateCategoryChart() {
        const totals = computeCategoryTotals();
        const entries = Array.from(totals.entries())
            .filter(([_, v]) => v > 0.000001)
            .sort((a, b) => b[1] - a[1]); // å¹´å‡é‡‘é¢é™åº

        const labels = entries.map(([k]) => k);
        const data = entries.map(([_, v]) => v);

        renderOrUpdateChart(labels, data);
    }

    /* ===== åˆå§‹åŒ– ===== */
    function addRow(data) {
        $('#tbody').append(buildRow(data));
        updateMoveButtons();
    }

    function mountRows(rows) {
        $('#tbody').empty();
        rows.forEach(r => addRow(r));
        computeTotals();
        updateMoveButtons();
        applyColsVisibility(loadColsVisibility());
        updateCategoryChart();
    }

    function bindImport() {
        const fileInput = document.getElementById('importFile');
        document.getElementById('importCSV').addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    importCSVFromText(String(e.target.result || ''));
                } catch (err) {
                    console.error(err);
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯');
                } finally {
                    fileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
                fileInput.value = '';
            };
            reader.readAsText(file, 'utf-8');
        });
    }

    $(function () {
        initYearsSelect();
        bindImport();

        const saved = loadFromLocalStorage();
        mountRows(saved && saved.length ? saved : TEMPLATE_ROWS);

        $('#addRow').on('click', () => {
            addRow({cat: "å…¶å®ƒ", name: "", period: "æ¯æœˆ", amount: 0});
            saveToLocalStorage();
            applyColsVisibility(loadColsVisibility());
            updateCategoryChart();
        });
        $('#restoreTemplate').on('click', () => {
            mountRows(TEMPLATE_ROWS);
            clearLocal();
            saveToLocalStorage();
            updateCategoryChart();
        });
        $('#clearAll').on('click', () => {
            $('#tbody').empty();
            computeTotals();
            clearLocal();
            updateMoveButtons();
            updateCategoryChart();
        });
        $('#exportCSV').on('click', exportCSV);

        const colState = loadColsVisibility();
        bindColsToggles(colState);
        applyColsVisibility(colState);
    });
</script>
</body>
</html>
