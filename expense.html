<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <link rel="icon" href="dist/favicon/expense.ico"/>
    <title>消费盘点</title>
    <!-- Bootstrap & jQuery（与现页一致的技术栈） -->
    <link rel="stylesheet" type="text/css" href="dist/css/c070423032508.css">
    <link rel="stylesheet" type="text/css" href="dist/css/c220423282110.css">
    <link rel="stylesheet" href="dist/css/bootstrap.min.css">
    <script src="dist/js/jquery-3.7.0.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <script src="dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: #fff;
            padding-bottom: 60px;
        }

        .page-title {
            font-weight: 700;
            letter-spacing: .5px;
        }

        .th-info {
            color: #6c757d;
            font-weight: 400;
            font-size: .85rem;
        }

        .card-soft {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: .75rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .03);
        }

        .table thead th {
            white-space: nowrap;
            vertical-align: bottom;
            position: sticky;
            top: 0;
            z-index: 2;
            background: #212529;
            color: #fff;
            border-color: #212529;
        }

        .table td, .table th {
            vertical-align: middle;
        }

        .num {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .muted {
            color: #6c757d;
        }

        .tfoot-total td {
            font-weight: 800;
            font-size: 1.05rem;
            background: #fcfcfd;
            border-top: 2px solid #343a40;
        }

        .btn-black {
            background: #000;
            color: #fff;
        }

        .btn-black:hover {
            color: #fff;
            filter: brightness(1.1);
        }

        .tag {
            padding: .2rem .4rem;
            border-radius: .35rem;
            background: #f1f3f5;
            font-size: .8rem;
        }

        .table-responsive {
            width: 100%;
        }

        .table {
            width: 100%;
        }

        .bottom-navigation {
            z-index: 1000;
        }

        .btn-ops-group .btn {
            margin: 0 .15rem;
        }

        /* 列隐藏统一样式 */
        .col-hidden {
            display: none !important;
        }

        /* ====== 图表区域样式（与现有风格统一） ====== */
        .chart-wrap {
            position: relative;
            min-height: 260px;
        }

        .legend {
            line-height: 1.2;
        }

        .legend .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #e9ecef;
            border-radius: .5rem;
            padding: .4rem .6rem;
            background: #fff;
            margin-bottom: .5rem;
        }

        .legend .legend-left {
            display: flex;
            align-items: center;
            min-width: 0;
        }

        .legend .legend-box {
            width: 14px;
            height: 14px;
            border: 1px solid #ced4da;
            margin-right: 8px;
        }

        .legend .legend-label {
            font-weight: 600;
            color: #212529;
            white-space: nowrap;
        }

        .legend .legend-right {
            text-align: right;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            margin-left: 8px;
        }

        .legend .legend-amt {
            color: #212529;
        }

        .legend .legend-pct {
            color: #6c757d;
            margin-left: 6px;
        }

        .chart-empty {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: .95rem;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px dashed #e9ecef;
            border-radius: .75rem;
        }

        .chart-empty.show {
            display: flex;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4 px-3">
    <div class="d-flex align-items-center mb-3">
        <h2 class="page-title mb-0">消费盘点</h2>
        <div class="ml-3 tag">日均 / 月均 / 年均 / 30年 / <span id="yearsLabel">--</span>年</div>
    </div>

    <!-- ===== 新增：类目消费占比（圆环图） ===== -->
    <div class="card-soft p-3 mb-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 mr-2">类目消费占比</h5>
                <span class="th-info">口径：年均金额（=日均×365）</span>
            </div>
            <div id="chartSummary" class="small text-muted">—</div>
        </div>
        <div class="row align-items-center">
            <div class="col-md-7">
                <div class="chart-wrap p-2">
                    <canvas id="categoryChart" height="200"></canvas>
                    <div id="chartEmpty" class="chart-empty">暂无数据</div>
                </div>
            </div>
            <div class="col-md-5">
                <div id="categoryLegend" class="legend small"></div>
            </div>
        </div>
    </div>

    <!-- 控件区 -->
    <div class="card-soft p-3 mb-3">
        <div class="d-flex flex-wrap align-items-center">
            <div class="mr-2 mb-2">
                <button id="addRow" class="btn btn-outline-secondary">＋ 添加一行</button>
            </div>
            <div class="mr-2 mb-2">
                <button id="restoreTemplate" class="btn btn-outline-secondary">↺ 恢复示例模板</button>
            </div>
            <div class="mr-2 mb-2">
                <button id="clearAll" class="btn btn-outline-secondary">🗑 清空全部</button>
            </div>

            <!-- 导入/导出 -->
            <div class="mr-2 mb-2">
                <button id="importCSV" class="btn btn-outline-primary">⤒ 导入 CSV</button>
                <input id="importFile" type="file" accept=".csv,text/csv" class="d-none"/>
            </div>
            <div class="mr-2 mb-2">
                <button id="exportCSV" class="btn btn-black">⤓ 导出 CSV</button>
            </div>
        </div>

        <!-- 显示列控制 -->
        <div class="mt-2">
            <div class="small text-muted mb-1">显示列（可勾选/取消，支持持久化记忆）</div>
            <div class="d-flex flex-wrap align-items-center">
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggleDaily" checked> 日均
                </label>
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggleMonthly" checked> 月均
                </label>
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggleYearly" checked> 年均
                </label>
                <label class="mr-3 mb-2">
                    <input type="checkbox" id="toggle30y" checked> 30年
                </label>
                <label class="mr-3 mb-2 d-flex align-items-center">
                    <input type="checkbox" id="toggleCustom" checked> <span class="ml-1" id="yearsLabel2">自定义</span>年
                </label>
            </div>
        </div>
    </div>

    <!-- 表格 -->
    <div class="table-responsive">
        <table id="expenseTable" class="table table-hover table-bordered mb-0">
            <thead class="thead-dark">
            <tr>
                <th style="min-width:90px;">类目</th>
                <th style="min-width:180px;">项目</th>
                <th style="min-width:100px;">周期</th>
                <th class="num">支出¥</th>
                <th class="num th-daily">日均¥</th>
                <th class="num th-monthly">月均¥</th>
                <th class="num th-yearly">年均¥</th>
                <th class="num th-30y">30年¥</th>
                <th class="num th-custom">
                    <div class="d-flex align-items-center justify-content-center">
                        <select id="yearsSelect" class="custom-select custom-select-sm w-auto"></select>
                        <span class="ml-1">¥</span>
                    </div>
                </th>
                <th class="text-center" style="min-width:90px;">操作</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
            <tfoot>
            <tr class="tfoot-total">
                <td colspan="3" class="text-right">合计</td>
                <td class="num" id="sumD">0.00</td>
                <td class="num tfoot-daily" id="sumE">0.00</td>
                <td class="num tfoot-monthly" id="sumF">0.00</td>
                <td class="num tfoot-yearly" id="sumG">0.00</td>
                <td class="num tfoot-30y" id="sumH">0.00</td>
                <td class="num tfoot-custom" id="sumI">0.00</td>
                <td></td>
            </tr>
            </tfoot>
        </table>
    </div>

    <div class="small text-muted mt-2">
        周期天数映射：每天=1， 每周=7， 每月=30， 每年=365，
        每2年=730...
    </div>
</div>

<div class="bottom-navigation">
    <a href="index.html">💰 FIRE计算器</a>
    <a href="life.html">⏰ 生命倒计时</a>
    <a href="expense.html">🧾 消费盘点</a>
    <!--<a href="clock.html">⏰ FIRE时钟</a>-->
    <a href="rental.html">🏠 房产租售比</a>
</div>

<!-- 引入 Chart.js（与计算器页一致的路径） -->
<script src="dist/chart.min.js"></script>

<script>
    /* ===== 配置 ===== */
    // 扩展周期可选项：新增 每6年~每10年
    const PERIOD_OPTIONS = [
        "每天", "每周", "每月", "每年",
        "每2年", "每3年", "每4年", "每5年",
        "每6年", "每7年", "每8年", "每9年", "每10年"
    ];
    const PERIOD_TO_DAYS = {
        "每天": 1, "每周": 7, "每月": 30, "每年": 365,
        "每2年": 2 * 365, "每3年": 3 * 365, "每4年": 4 * 365, "每5年": 5 * 365,
        "每6年": 6 * 365, "每7年": 7 * 365, "每8年": 8 * 365, "每9年": 9 * 365, "每10年": 10 * 365
    };
    const CATEGORY_OPTIONS = ["饮食", "娱乐", "电子", "生活", "家电", "交通", "旅游", "其它"];

    const YEARS_DEFAULT = 40;
    const LS_KEY = 'expense_rows_v1';
    const LS_YEARS_KEY = 'expense_years_v1';

    // 列显示状态持久化键
    const LS_COLS_KEY = 'expense_cols_visibility_v1';
    // 列选择器定义
    const COLS = {
        daily: {th: '.th-daily', tds: 'td.cell-daily', tf: 'td.tfoot-daily'},
        monthly: {th: '.th-monthly', tds: 'td.cell-monthly', tf: 'td.tfoot-monthly'},
        yearly: {th: '.th-yearly', tds: 'td.cell-yearly', tf: 'td.tfoot-yearly'},
        y30: {th: '.th-30y', tds: 'td.cell-30y', tf: 'td.tfoot-30y'},
        custom: {th: '.th-custom', tds: 'td.cell-custom-y', tf: 'td.tfoot-custom'}
    };

    let selectedYears = YEARS_DEFAULT;

    /* 示例模板(保持不变，可自由编辑) */
    const TEMPLATE_ROWS = [
        {cat: "饮食", name: "早餐", period: "每天", amount: 3},
        {cat: "饮食", name: "中饭(自己做)", period: "每天", amount: 15},
        {cat: "饮食", name: "晚饭(鸡蛋+牛奶+玉米等)", period: "每天", amount: 7},
        {cat: "饮食", name: "水果", period: "每天", amount: 6},
        {cat: "饮食", name: "吃大餐(每月2~3次)", period: "每月", amount: 200},
        {cat: "娱乐", name: "电影票(每月2~3张)", period: "每月", amount: 200},
        {cat: "电子", name: "手机", period: "每3年", amount: 3000},
        {cat: "电子", name: "电脑(含显卡)", period: "每4年", amount: 8000},
        {cat: "电子", name: "外设(显示器/音箱)", period: "每4年", amount: 5000},
        {cat: "生活", name: "话费+网费(电信1000M)", period: "每月", amount: 199},
        {cat: "生活", name: "运动器械(含损坏更换)", period: "每年", amount: 1000},
        {cat: "生活", name: "水电燃气", period: "每年", amount: 3000},
        {cat: "生活", name: "物业费(含损耗维护)", period: "每年", amount: 1500},
        {cat: "家电", name: "冰箱", period: "每5年", amount: 1500},
        {cat: "家电", name: "洗衣机", period: "每5年", amount: 2000},
        {cat: "家电", name: "烘干机", period: "每5年", amount: 2000},
        {cat: "家电", name: "空调", period: "每5年", amount: 2000},
        {cat: "交通", name: "交通费(市域地铁)", period: "每月", amount: 40},
        {cat: "交通", name: "交通费(城际高铁)", period: "每年", amount: 1000},
        {cat: "交通", name: "交通费(小电驴及充电)", period: "每3年", amount: 3000},
        {cat: "旅游", name: "", period: "每年", amount: 0},
        {cat: "其它", name: "衣物/日用/医疗/人情/学习…", period: "每年", amount: 1000}
    ];

    /* ===== 工具函数 ===== */
    const fmt = n => Number(n || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    // 合计使用“纯数字”（无千分位）
    const fmtPlain = n => (Number(n || 0)).toFixed(2);
    const parseNum = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    function calcByDays(amount, days) {
        if (!days) return {E: 0, F: 0, G: 0, H: 0, I: 0};
        const E = amount / days;   // 日均
        const F = E * 30;          // 月均
        const G = E * 365;         // 年均
        const H = G * 30;          // 30年
        const I = G * selectedYears; // N年（下拉可选）
        return {E, F, G, H, I};
    }

    function buildSelect(options, selected) {
        const $sel = $('<select class="form-control form-control-sm"></select>');
        options.forEach(opt => {
            $sel.append(`<option ${opt === selected ? 'selected' : ''}>${opt}</option>`);
        });
        return $sel;
    }

    function buildRow(data = {cat: "其它", name: "", period: "每月", amount: 0}) {
        const $tr = $('<tr></tr>');
        const $cat = buildSelect(CATEGORY_OPTIONS, data.cat).addClass('input-cat');
        const $name = $(`<input type="text" class="form-control form-control-sm input-name" placeholder="">`).val(data.name);
        const $period = buildSelect(PERIOD_OPTIONS, data.period).addClass('select-period');
        const $amount = $(`<input type="number" class="form-control form-control-sm input-amount num" step="0.01" min="0">`).val(data.amount);

        const $tdCat = $('<td></td>').append($cat);
        const $tdName = $('<td></td>').append($name);
        const $tdPer = $('<td></td>').append($period);
        const $tdAmt = $('<td class="num"></td>').append($amount);
        const $tdE = $('<td class="num cell-daily">0.00</td>');
        const $tdF = $('<td class="num cell-monthly">0.00</td>');
        const $tdG = $('<td class="num cell-yearly">0.00</td>');
        const $tdH = $('<td class="num cell-30y">0.00</td>');
        const $tdI = $('<td class="num cell-custom-y">0.00</td>');

        // 操作列：上移 / 下移 / 删除
        const $btnUp = $('<button class="btn btn-sm btn-outline-secondary btn-move-up" title="上移">↑</button>');
        const $btnDown = $('<button class="btn btn-sm btn-outline-secondary btn-move-down" title="下移">↓</button>');
        const $btnDel = $('<button class="btn btn-sm btn-outline-danger btn-del" title="删除">删除</button>');
        const $opsWrap = $('<div class="btn-ops-group d-inline-flex align-items-center"></div>').append($btnUp, $btnDown, $btnDel);
        const $tdOps = $('<td class="text-center"></td>').append($opsWrap);

        $tr.append($tdCat, $tdName, $tdPer, $tdAmt, $tdE, $tdF, $tdG, $tdH, $tdI, $tdOps);

        // 事件
        $tr.on('input change', '.input-amount, .select-period, .input-name, .input-cat', () => {
            computeRow($tr);
            computeTotals();
            saveToLocalStorage();
            updateCategoryChart(); // 图表联动
        });

        $tr.on('click', '.btn-del', () => {
            $tr.remove();
            computeTotals();
            saveToLocalStorage();
            updateMoveButtons();
            updateCategoryChart(); // 图表联动
        });

        $tr.on('click', '.btn-move-up', () => {
            const $prev = $tr.prev('tr');
            if ($prev.length) {
                $tr.insertBefore($prev);
                computeTotals();
                saveToLocalStorage();
                updateMoveButtons();
                updateCategoryChart(); // 图表联动
            }
        });

        $tr.on('click', '.btn-move-down', () => {
            const $next = $tr.next('tr');
            if ($next.length) {
                $tr.insertAfter($next);
                computeTotals();
                saveToLocalStorage();
                updateMoveButtons();
                updateCategoryChart(); // 图表联动
            }
        });

        computeRow($tr);
        return $tr;
    }

    function updateMoveButtons() {
        const $rows = $('#tbody tr');
        $rows.find('.btn-move-up, .btn-move-down').prop('disabled', false);
        if ($rows.length === 0) return;
        $rows.first().find('.btn-move-up').prop('disabled', true);
        $rows.last().find('.btn-move-down').prop('disabled', true);
    }

    function computeRow($tr) {
        const amount = parseNum($tr.find('.input-amount').val());
        const period = $tr.find('.select-period').val();
        const days = PERIOD_TO_DAYS[period] || 0;
        const {E, F, G, H, I} = calcByDays(amount, days);
        $tr.find('.cell-daily').text(fmt(E));
        $tr.find('.cell-monthly').text(fmt(F));
        $tr.find('.cell-yearly').text(fmt(G));
        $tr.find('.cell-30y').text(fmt(H));
        $tr.find('.cell-custom-y').text(fmt(I));
    }

    function computeTotals() {
        let sumD = 0, sumE = 0, sumF = 0, sumG = 0, sumH = 0, sumI = 0;
        $('#tbody tr').each(function () {
            const $tr = $(this);
            const amount = parseNum($tr.find('.input-amount').val());
            const e = parseNum($tr.find('.cell-daily').text().replace(/,/g, ''));
            const f = parseNum($tr.find('.cell-monthly').text().replace(/,/g, ''));
            const g = parseNum($tr.find('.cell-yearly').text().replace(/,/g, ''));
            const h = parseNum($tr.find('.cell-30y').text().replace(/,/g, ''));
            const i = parseNum($tr.find('.cell-custom-y').text().replace(/,/g, ''));
            sumD += amount;
            sumE += e;
            sumF += f;
            sumG += g;
            sumH += h;
            sumI += i;
        });
        $('#sumD').text(fmtPlain(sumD));
        $('#sumE').text(fmtPlain(sumE));
        $('#sumF').text(fmtPlain(sumF));
        $('#sumG').text(fmtPlain(sumG));
        $('#sumH').text(fmtPlain(sumH));
        $('#sumI').text(fmtPlain(sumI));
        // 汇总文字（图表右上角）
        const sumGNum = Number(sumG || 0);
        document.getElementById('chartSummary').textContent =
            '年均合计：¥ ' + sumGNum.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function recomputeAll() {
        $('#tbody tr').each(function () {
            computeRow($(this));
        });
        computeTotals();
        updateMoveButtons();
    }

    /* ===== LocalStorage（行数据） ===== */
    function saveToLocalStorage() {
        const rows = [];
        $('#tbody tr').each(function () {
            rows.push({
                cat: $(this).find('.input-cat').val(),
                name: $(this).find('.input-name').val(),
                period: $(this).find('.select-period').val(),
                amount: parseNum($(this).find('.input-amount').val())
            });
        });
        localStorage.setItem(LS_KEY, JSON.stringify(rows));
    }

    function loadFromLocalStorage() {
        try {
            const json = localStorage.getItem(LS_KEY);
            if (!json) return null;
            const rows = JSON.parse(json);
            if (!Array.isArray(rows)) return null;
            return rows;
        } catch (e) {
            return null;
        }
    }

    function clearLocal() {
        localStorage.removeItem(LS_KEY);
    }

    /* ===== LocalStorage（年数） ===== */
    function saveYearsToLocalStorage() {
        localStorage.setItem(LS_YEARS_KEY, String(selectedYears));
    }

    function loadYearsFromLocalStorage() {
        const v = localStorage.getItem(LS_YEARS_KEY);
        if (!v) return YEARS_DEFAULT;
        const n = parseInt(v, 10);
        return (Number.isFinite(n) && n >= 1 && n <= 100) ? n : YEARS_DEFAULT;
    }

    /* ===== 年数下拉初始化 ===== */
    function initYearsSelect() {
        const $sel = $('#yearsSelect');
        $sel.empty();
        for (let i = 1; i <= 100; i++) $sel.append(`<option value="${i}">${i}</option>`);
        selectedYears = loadYearsFromLocalStorage();
        $sel.val(String(selectedYears));
        updateYearsUI();

        $sel.on('change', () => {
            selectedYears = parseInt($sel.val(), 10) || YEARS_DEFAULT;
            saveYearsToLocalStorage();
            updateYearsUI();
            recomputeAll();
            updateCategoryChart(); // 年数变化不影响年均，但保持同步
        });
    }

    function updateYearsUI() {
        $('#yearsLabel').text(String(selectedYears));
        $('#yearsLabel2').text(String(selectedYears));
    }

    /* ===== CSV 导入/导出 ===== */
    function parseCSVLine(line) {
        const out = [];
        let cur = '', inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i], next = line[i + 1];
            if (inQuotes) {
                if (ch === '"' && next === '"') {
                    cur += '"';
                    i++;
                } else if (ch === '"') {
                    inQuotes = false;
                } else {
                    cur += ch;
                }
            } else {
                if (ch === '"') {
                    inQuotes = true;
                } else if (ch === ',') {
                    out.push(cur);
                    cur = '';
                } else {
                    cur += ch;
                }
            }
        }
        out.push(cur);
        return out;
    }

    function exportCSV() {
        const header = ["类目", "项目", "周期", "支出(¥)", "日均(¥)", "月均(¥)", "年均(¥)", "30年(¥)", `${selectedYears}年(¥)`];
        const lines = [header.join(',')];
        $('#tbody tr').each(function () {
            const tds = $(this).find('td');
            const row = [
                $(tds[0]).find('select').val(),
                (($(tds[1]).find('input').val() || '').replace(/,/g, ' ')),
                $(tds[2]).find('select').val(),
                parseNum($(tds[3]).find('input').val()),
                $(tds[4]).text().replace(/,/g, ''),
                $(tds[5]).text().replace(/,/g, ''),
                $(tds[6]).text().replace(/,/g, ''),
                $(tds[7]).text().replace(/,/g, ''),
                $(tds[8]).text().replace(/,/g, '')
            ];
            lines.push(row.join(','));
        });
        const sum = ["合计", "", "",
            $('#sumD').text().replace(/,/g, ''),
            $('#sumE').text().replace(/,/g, ''),
            $('#sumF').text().replace(/,/g, ''),
            $('#sumG').text().replace(/,/g, ''),
            $('#sumH').text().replace(/,/g, ''),
            $('#sumI').text().replace(/,/g, '')];
        lines.push(sum.join(','));

        const blob = new Blob(['\ufeff' + lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = '消费盘点.csv';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function importCSVFromText(text) {
        if (!text) return;
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lines.length < 2) {
            alert('CSV 内容为空或格式不正确');
            return;
        }

        const header = parseCSVLine(lines[0]);
        let importedYears = selectedYears;
        const lastHeader = header[header.length - 1] || '';
        const yearsMatch = lastHeader.match(/(\d+)\s*年/);
        if (yearsMatch) {
            const y = parseInt(yearsMatch[1], 10);
            if (Number.isFinite(y) && y >= 1 && y <= 100) importedYears = y;
        }
        if (header.length < 9) {
            alert('CSV 列数不足，无法导入');
            return;
        }

        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const arr = parseCSVLine(lines[i]);
            if (!arr.length) continue;
            if ((arr[0] || '').trim() === '合计') break;

            const cat = (arr[0] || '其它').trim() || '其它';
            const name = (arr[1] || '').trim();
            const period = (arr[2] || '每月').trim();
            const amount = parseNum(arr[3]);

            rows.push({cat, name, period, amount});
        }
        if (!rows.length) {
            alert('未解析到有效数据行');
            return;
        }

        selectedYears = importedYears;
        $('#yearsSelect').val(String(selectedYears));
        updateYearsUI();
        saveYearsToLocalStorage();

        mountRows(rows);
        saveToLocalStorage();
        updateCategoryChart(); // 图表联动
    }

    function bindImport() {
        const fileInput = document.getElementById('importFile');
        document.getElementById('importCSV').addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    importCSVFromText(String(e.target.result || ''));
                } catch (err) {
                    console.error(err);
                    alert('导入失败：文件解析错误');
                } finally {
                    fileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert('读取文件失败');
                fileInput.value = '';
            };
            reader.readAsText(file, 'utf-8');
        });
    }

    /* ===== 列显示控制 ===== */
    function loadColsVisibility() {
        try {
            const json = localStorage.getItem(LS_COLS_KEY);
            if (!json) return {daily: true, monthly: true, yearly: true, y30: true, custom: true};
            const obj = JSON.parse(json);
            return {
                daily: obj.daily !== false,
                monthly: obj.monthly !== false,
                yearly: obj.yearly !== false,
                y30: obj.y30 !== false,
                custom: obj.custom !== false
            };
        } catch (_) {
            return {daily: true, monthly: true, yearly: true, y30: true, custom: true};
        }
    }

    function saveColsVisibility(state) {
        localStorage.setItem(LS_COLS_KEY, JSON.stringify(state));
    }

    function applyColsVisibility(state) {
        // 逐列处理：显示=移除隐藏类；隐藏=添加隐藏类
        Object.entries(COLS).forEach(([key, sel]) => {
            const show = !!state[key];
            $(sel.th).toggleClass('col-hidden', !show);
            $(sel.tds).toggleClass('col-hidden', !show);
            $(sel.tf).toggleClass('col-hidden', !show);
        });
    }

    function bindColsToggles(state) {
        const map = {
            daily: '#toggleDaily',
            monthly: '#toggleMonthly',
            yearly: '#toggleYearly',
            y30: '#toggle30y',
            custom: '#toggleCustom'
        };
        // 初始同步勾选状态
        Object.entries(map).forEach(([k, sel]) => {
            const el = document.querySelector(sel);
            if (el) el.checked = !!state[k];
        });
        // 绑定事件
        Object.entries(map).forEach(([k, sel]) => {
            $(sel).on('change', function () {
                state[k] = this.checked;
                saveColsVisibility(state);
                applyColsVisibility(state);
            });
        });
    }

    /* ====== 类目汇总 & 图表 ====== */
    // 与“截图风格”一致的柔和配色（固定顺序，类目不足会循环使用）
    const PALETTE = [
        '#3b82f6', // 蓝
        '#10b981', // 绿
        '#f59e0b', // 橙
        '#ef4444', // 红
        '#8b5cf6', // 紫
        '#06b6d4', // 青
        '#f97316', // 橘
        '#64748b'  // 灰
    ];

    let categoryChart = null;

    function getAnnualForRow($tr) {
        // 根据行数据计算年均金额（与表格一致：日均×365）
        const amount = parseNum($tr.find('.input-amount').val());
        const period = $tr.find('.select-period').val() || '每月';
        const days = PERIOD_TO_DAYS[period] || 0;
        if (!days) return 0;
        const E = amount / days;
        const G = E * 365;
        return G;
    }

    function computeCategoryTotals() {
        // 返回 {cat: annualSum}
        const map = new Map();
        $('#tbody tr').each(function () {
            const $tr = $(this);
            const cat = ($tr.find('.input-cat').val() || '其它');
            const annual = getAnnualForRow($tr);
            const prev = map.get(cat) || 0;
            map.set(cat, prev + annual);
        });
        return map;
    }

    function renderLegend(labels, colors, values, total) {
        const $legend = $('#categoryLegend');
        $legend.empty();
        if (total <= 0 || labels.length === 0) return;

        labels.forEach((lbl, idx) => {
            const val = values[idx] || 0;
            const pct = total > 0 ? (val / total * 100) : 0;
            const $item = $(`
                <div class="legend-item">
                    <div class="legend-left">
                        <span class="legend-box" style="background:${colors[idx]}"></span>
                        <span class="legend-label">${lbl}</span>
                    </div>
                    <div class="legend-right">
                        <span class="legend-amt">¥ ${val.toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}</span>
                        <span class="legend-pct">(${pct.toFixed(1)}%)</span>
                    </div>
                </div>
            `);
            $legend.append($item);
        });
    }

    function updateCategoryChart() {
        const totals = computeCategoryTotals();
        // 仅保留 >0 的类目
        const labels = [];
        const data = [];
        totals.forEach((v, k) => {
            if (v > 0.000001) {
                labels.push(k);
                data.push(v);
            }
        });

        const total = data.reduce((a, b) => a + b, 0);
        const emptyEl = document.getElementById('chartEmpty');
        if (total <= 0) {
            // 清空图表并显示“暂无数据”
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }
            emptyEl.classList.add('show');
            $('#categoryLegend').empty();
            return;
        } else {
            emptyEl.classList.remove('show');
        }

        // 颜色（按 labels 顺序轮询 PALETTE）
        const colors = labels.map((_, i) => PALETTE[i % PALETTE.length]);

        // 图表配置
        const ctx = document.getElementById('categoryChart').getContext('2d');

        // 重建图表（避免 dataset 动态增删导致的引用问题）
        if (categoryChart) {
            categoryChart.destroy();
        }
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '62%',
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const v = ctx.parsed || 0;
                                const p = total > 0 ? (v / total * 100) : 0;
                                return `${ctx.label}: ¥ ${v.toLocaleString('zh-CN', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                })}  (${p.toFixed(1)}%)`;
                            }
                        }
                    }
                }
            }
        });

        // 自定义图例
        renderLegend(labels, colors, data, total);
    }

    /* ===== 初始化 ===== */
    function addRow(data) {
        $('#tbody').append(buildRow(data));
        updateMoveButtons();
    }

    function mountRows(rows) {
        $('#tbody').empty();
        rows.forEach(r => addRow(r));
        computeTotals();
        updateMoveButtons();

        // 应用列隐藏到新渲染的行
        applyColsVisibility(loadColsVisibility());

        // 渲染图表
        updateCategoryChart();
    }

    $(function () {
        // 初始化“年数”选择 & 导入绑定
        initYearsSelect();
        bindImport();

        // 载入本地或模板
        const saved = loadFromLocalStorage();
        mountRows(saved && saved.length ? saved : TEMPLATE_ROWS);

        // 绑定按钮
        $('#addRow').on('click', () => {
            addRow({cat: "其它", name: "", period: "每月", amount: 0});
            saveToLocalStorage();
            // 新增行也要应用列隐藏
            applyColsVisibility(loadColsVisibility());
            updateCategoryChart(); // 图表联动
        });
        $('#restoreTemplate').on('click', () => {
            mountRows(TEMPLATE_ROWS);
            clearLocal();
            saveToLocalStorage();
            updateCategoryChart(); // 图表联动
        });
        $('#clearAll').on('click', () => {
            $('#tbody').empty();
            computeTotals();
            clearLocal();
            updateMoveButtons();
            updateCategoryChart(); // 图表联动
        });
        $('#exportCSV').on('click', exportCSV);

        // 列显示控制：加载状态、绑定事件、首次应用
        const colState = loadColsVisibility();
        bindColsToggles(colState);
        applyColsVisibility(colState);
    });
</script>
</body>
</html>
