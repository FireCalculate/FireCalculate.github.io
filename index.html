<!DOCTYPE html>
<html>
<head>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <link rel="icon" href="dist/favicon.ico"/>
    <title>ğŸ’°FIREè®¡ç®—å™¨</title>
    <link rel="stylesheet" href="dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="dist/css/c070423032508.css">
    <link rel="stylesheet" type="text/css" href="dist/css/c220423282110.css">
</head>
<body>
<h2 id="pageTitle"></h2>
<div class="row">
    <div class="col-md-4 form-group">
        <label for="principal">æœ¬é‡‘:</label>
        <div class="input-group">
            <input type="number" id="principal" class="form-control form-control-lg" min="0" max="999999999"
                   step="100000" value="2000000" oninput="limitInputLength(this, 15)"/>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="decrementPrincipal()">-</button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="incrementPrincipal()">+</button>
            </div>
        </div>
        <span id="principalDisplay" class="text-muted"></span>
    </div>
    <div class="col-md-4 form-group">
        <label for="annualInterestRate">å¹´åŒ–åˆ©ç‡%:</label>
        <div class="input-group">
            <input type="number" id="annualInterestRate" class="form-control form-control-lg" min="0" max="1000"
                   step="0.1" value="2.000" oninput="limitInputLength(this, 6)"/>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="resetInterestRate()">Ã—</button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="decrementInterestRate()">-
                </button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="incrementInterestRate()">+
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-4 form-group">
        <label for="stableIncome">ç¨³å®šå¹´æ”¶å…¥<span class="th-info">(é€€ä¼‘é‡‘/æ”¶ç§Ÿ/å‰¯ä¸šç­‰)</span>:</label>
        <div class="input-group">
            <input type="number" id="stableIncome" class="form-control form-control-lg" min="0" max="999999999"
                   step="10000" value="0"
                   oninput="limitInputLength(this, 10)"/>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="resetStableIncome()">Ã—</button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="decrementStableIncome()">-
                </button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="incrementStableIncome()">+
                </button>
            </div>
        </div>
        <span id="stableIncomeDisplay" class="text-muted"></span>
    </div>
</div>
<div class="row">
    <div class="col-md-4 form-group bg-liability">
        <label for="annualExpenses">å¹´æ¶ˆè´¹<a href="expense.html" target="_blank" class="th-info alert-link-life">(â†’æ¶ˆè´¹ç›˜ç‚¹)</a>:</label>
        <div class="input-group">
            <input type="number" id="annualExpenses" class="form-control form-control-lg" min="0" max="99999999"
                   step="5000" value="45000" oninput="limitInputLength(this, 10)"/>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="decrementAnnualExpenses()">-
                </button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="incrementAnnualExpenses()">+
                </button>
            </div>
        </div>
        <span id="monthlyExpensesDisplay" class="text-muted"></span>
    </div>
    <div class="col-md-4 form-group bg-liability">
        <label for="inflationRate">é€šèƒ€ç‡%:</label>
        <div class="input-group">
            <input type="number" id="inflationRate" class="form-control form-control-lg" min="0" max="1000" step="0.1"
                   value="2.229" oninput="limitInputLength(this, 6)"/>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="resetInflationRate()">Ã—</button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="decrementInflationRate()">-
                </button>
                <button class="btn btn-outline-secondary btn-lg" type="button" onclick="incrementInflationRate()">+
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-4 form-group d-flex justify-content-center align-items-center">
        <label><br></label>
        <div class="input-group justify-content-center">
            <button class="btn btn-black btn-lg" onclick="calculateInterest()">è®¡ç®—</button>
            <button class="btn btn-outline-secondary btn-lg ml-2" onclick="resetAllData()">é‡ç½®</button>
        </div>
    </div>
</div>

<div style="position: relative;">
    <canvas id="lineChart" width="400" height="200"></canvas>
    <div id="floatingText" class="floating-text"></div>
</div>
<table class="table table-hover mt-4">
    <thead class="thead-dark">
    <tr>
        <th class="text-center align-top">
            <div class="d-flex flex-column align-items-center justify-content-center">
                <span class="mr-2">å¹´é¾„</span>
                <div class="d-flex flex-column">
                    <div class="input-group">
                        <input type="number" id="startYear" class="form-control form-control-sm text-center" step="1"
                               placeholder="å¹´é¾„" readonly>
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="resetStartYear()">
                                Ã—
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" type="button"
                                    onclick="decrementStartYear()">â€¹
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" type="button"
                                    onclick="incrementStartYear()">â€º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </th>
        <th class="text-center align-top">å¹´æ¶ˆè´¹<br><span class="th-info expense-title"></span></th>
        <th class="text-center align-top">å¹´åˆ©æ¯<br><span class="th-info income-title"></span></th>
        <th class="text-center align-top">æœ¬é‡‘<br><span class="th-info">(ä¸Šå¹´æœ¬é‡‘-å¹´æ¶ˆè´¹+å¹´åˆ©æ¯+å¹´æ”¶å…¥)</span></th>
    </tr>
    </thead>
    <tbody id="resultTable">
    </tbody>
</table>


<div class="alert alert-info bg-fbfbfa border-0 rounded-0" role="alert">
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
            <p class="mb-2">
                ä¸­å›½è¿‘åå¹´é€šèƒ€ç‡å¹³å‡åœ¨ <strong>2.229%</strong> å·¦å³ï¼Œ
                <a href="https://www.baidu.com/s?wd=ä¸­å›½è¿‘åå¹´é€šèƒ€ç‡" target="_blank" class="alert-link">äº†è§£æ›´å¤š...</a>
            </p>
            <p class="mb-0">
                <span class="text-muted">æ¥è‡ª</span>
                <a href="https://www.douban.com/group/topic/292579186/" target="_blank" class="alert-link">
                    <span class="douban-logo">
                        <span class="douban-d">d</span>
                        <span class="douban-o">o</span>
                        <span class="douban-u">u</span>
                        <span class="douban-b">b</span>
                        <span class="douban-a">a</span>
                        <span class="douban-n">n</span>
                    </span>
                    å°ç»„è®¨è®º</a>ï¼Œæ¬¢è¿æ”¹è¿›
            </p>
        </div>
        <div class="ml-2">
            <!-- æ’å…¥å°åŠ¨ç”»å›¾ -->
            <img src="dist/note.gif" alt="">
        </div>
    </div>
</div>

<div class="modal" id="alertModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æç¤º</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul id="errorList"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>
<div class="bottom-navigation">
    <a href="index.html">ğŸ’° FIREè®¡ç®—å™¨</a>
    <a href="life.html">â° ç”Ÿå‘½å€’è®¡æ—¶</a>
    <a href="expense.html">ğŸ§¾ æ¶ˆè´¹ç›˜ç‚¹</a>
    <!--<a href="clock.html">â° FIREæ—¶é’Ÿ</a>-->
    <a href="rental.html">ğŸ  æˆ¿äº§ç§Ÿå”®æ¯”</a>
</div>
<script src="dist/js/jquery-3.7.0.min.js"></script>
<script src="dist/js/bootstrap.min.js"></script>
<script src="dist/js/j020423032508.js"></script>
<script src="dist/chart.min.js"></script>
<script>
    // æ›´æ–°è¡¨å•æ•°æ®åˆ° localStorage
    function updateLocalStorage() {
        localStorage.setItem('principal', principalEle.value);
        localStorage.setItem('annualInterestRate', annualInterestRateEle.value);
        localStorage.setItem('stableIncome', stableIncomeEle.value);
        localStorage.setItem('annualExpenses', annualExpensesEle.value);
        localStorage.setItem('inflationRate', inflationRateEle.value);
        localStorage.setItem('startYear', startYearEle.value);
        console.log(`Saving to localStorage: Principal: ${principalEle.value}, Annual Interest Rate: ${annualInterestRateEle.value}, Stable Income: ${stableIncomeEle.value}, Annual Expenses: ${annualExpensesEle.value}, Inflation Rate: ${inflationRateEle.value}, Start Year: ${startYearEle.value}`);
    }

    updatePrincipalDisplay();
    updateMonthlyExpensesDisplay();
    updateStableIncomeDisplay();
    principalEle.addEventListener("input", function () {
        updatePrincipalDisplay();
        updateLocalStorage();
    });
    annualInterestRateEle.addEventListener("input", function () {
        updateLocalStorage();
    });
    stableIncomeEle.addEventListener("input", function () {
        updateStableIncomeDisplay();
        updateLocalStorage();
    });
    annualExpensesEle.addEventListener("input", function () {
        updateMonthlyExpensesDisplay();
        updateLocalStorage();
    });
    inflationRateEle.addEventListener("input", function () {
        updateLocalStorage();
    });
    startYearEle.addEventListener("input", function () {
        updateLocalStorage();
    });

    startYearEle.value = currentSystemYear;

    function calculateInterest(noChart) {
        //console.log(additionalExpensesMap)
        let principal = parseFloat(principalEle.value.toString());
        let annualInterestRate = parseFloat(annualInterestRateEle.value);
        let stableIncome = parseFloat(stableIncomeEle.value.toString());
        let annualExpenses = parseFloat(annualExpensesEle.value.toString());
        let inflationRate = parseFloat(inflationRateEle.value);
        let yearCount = 1;
        let maxIterations = 101;
        let floatingInfo = parseFloatInfo(principal, annualInterestRate, stableIncome, annualExpenses, inflationRate);
        let errors = parseError(principal, annualInterestRate, stableIncome, annualExpenses, inflationRate);
        if (errors.length > 0) {
            showAlert(errors);
            return;
        }

        let resultTable = document.getElementById("resultTable");
        let pageTitle = document.getElementById("pageTitle");
        let startYear = parseInt(startYearEle.value);
        resultTable.innerHTML = "";

        let years = [];
        let interests = [];
        let principals = [];
        let expenses = [];

        liveYear = -1;
        let negativeTimes = 0;
        let annualInterest;
        annualExpenses *= -1;

        let currentYear = startYear;
        while (maxIterations > 0) {
            annualExpenses = (1 + (inflationRate / 100)) * annualExpenses;

            let additionalExpenses = additionalExpensesMap.has(yearCount) ? additionalExpensesMap.get(yearCount) : 0;
            let additionalIncome = additionalIncomeMap.has(yearCount) ? additionalIncomeMap.get(yearCount) : 0;

            annualInterest = (principal - ((annualExpenses + additionalExpenses) * -1)) * (annualInterestRate / 100);
            principal = principal + (annualExpenses + additionalExpenses) + annualInterest + additionalIncome + stableIncome;

            //å°†å¹´åˆ©æ¯å’Œæœ¬é‡‘å°äº0çš„å€¼æ›¿æ¢ä¸º0
            annualInterest = Math.max(annualInterest, 0);
            principal = Math.max(principal, 0);

            let newRow = resultTable.insertRow();
            let year = newRow.insertCell(0);
            let annualExpensesCell = newRow.insertCell(1);
            let interestCell = newRow.insertCell(2);
            let principalCell = newRow.insertCell(3);

            year.classList.add("text-center");
            annualExpensesCell.classList.add("annual-expenses-cell", "text-center");
            interestCell.classList.add("interest-cell", "text-center");
            principalCell.classList.add("principal-cell", "text-center");
            let aaa = `<br><a href='life.html' target='_blank' class='alert-link-life'>(ç”·æ€§å¯¿å‘½çº¦75.37å²)</a>`;
            let bbb = `<br><a href='life.html' target='_blank' class='alert-link-life'>(å¥³æ€§å¯¿å‘½çº¦80.88å²)</a>`;
            year.innerHTML = yearCount + "<sub class='subscript'>" + (isNaN(currentYear) ? "" : " " + currentYear + (currentYear === 75 ? aaa : (currentYear === 80 ? bbb : ""))) + "</sub>";
            innerHTMLExpense(annualExpensesCell, annualExpenses, additionalExpenses, principal);
            innerHTMLIncome(interestCell, annualInterest, additionalIncome);
            principalCell.innerHTML = principal.toFixed(2);

            years.push(yearCount);
            expenses.push((annualExpenses + additionalExpenses).toFixed(2));
            interests.push((annualInterest + additionalIncome).toFixed(2));
            principals.push(principal.toFixed(2));

            //è®¡ç®—å¹¶æ˜¾ç¤ºå‰©ä½™å¹´æ•°
            if (liveYear == -1 && principal <= 0) {
                liveYear = yearCount - 1;
            }

            if (principal <= 0) {
                newRow.classList.add("negative");
                negativeTimes++;
            }

            if (negativeTimes > 3 || maxIterations == 1) {
                year.innerHTML = "â‹®";
                interestCell.innerHTML = "â‹®";
                annualExpensesCell.innerHTML = "â‹®";
                principalCell.innerHTML = "â‹®";
            }
            if (negativeTimes > 3) {
                break;
            }
            yearCount++;
            maxIterations--;
            if (!isNaN(currentYear)) {
                currentYear++;
            }
        }
        setTableTitle();
        pageTitle.innerHTML = "ğŸ’°FIREè®¡ç®—å™¨ï¼ˆè¿˜èƒ½æ´»" + "<span class='liveYear'>" + (liveYear != -1 ? liveYear : '100+') + "</span>å¹´ï¼‰";
        drawLineChart(noChart, years, interests, principals, expenses);
        showFloatingInfo(floatingInfo, liveYear != -1 ? liveYear : 100);
    }

    // é¡µé¢åŠ è½½æ—¶ä» localStorage æ¢å¤è¡¨å•æ•°æ®
    window.onload = function () {
        // è·å–æœ¬åœ°å­˜å‚¨çš„æ•°æ®
        let storedPrincipal = localStorage.getItem('principal');
        let storedAnnualInterestRate = localStorage.getItem('annualInterestRate');
        let storedStableIncome = localStorage.getItem('stableIncome');
        let storedAnnualExpenses = localStorage.getItem('annualExpenses');
        let storedInflationRate = localStorage.getItem('inflationRate');
        let storedStartYear = localStorage.getItem('startYear');

        // å¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æœ‰æ•°æ®ï¼Œåˆ™æ¢å¤è¡¨å•å€¼
        if (storedPrincipal) principalEle.value = storedPrincipal;
        if (storedAnnualInterestRate) annualInterestRateEle.value = storedAnnualInterestRate;
        if (storedStableIncome) stableIncomeEle.value = storedStableIncome;
        if (storedAnnualExpenses) annualExpensesEle.value = storedAnnualExpenses;
        if (storedInflationRate) inflationRateEle.value = storedInflationRate;
        if (storedStartYear) startYearEle.value = storedStartYear;

        console.log(`localStorage: Stored Principal: ${storedPrincipal}, Stored Annual Interest Rate: ${storedAnnualInterestRate}, Stored Stable Income: ${storedStableIncome}, Stored Annual Expenses: ${storedAnnualExpenses}, Stored Inflation Rate: ${storedInflationRate}, Stored Start Year: ${storedStartYear}`);
        // æ›´æ–°æ˜¾ç¤ºçš„æ•°å€¼
        updatePrincipalDisplay();
        updateMonthlyExpensesDisplay();
        updateStableIncomeDisplay();
        calculateInterest(); // é‡æ–°è®¡ç®—ä»¥æ›´æ–°é¡µé¢
    };

    function resetAllData() {
        // é‡ç½®è¡¨å•å­—æ®µ
        principalEle.value = 2000000;
        annualInterestRateEle.value = (2.000).toFixed(3);
        stableIncomeEle.value = 0;
        annualExpensesEle.value = 45000;
        inflationRateEle.value = 2.229;
        startYearEle.value = currentSystemYear;

        // æ¸…é™¤ localStorage ä¸­ä¿å­˜çš„æ•°æ®
        localStorage.removeItem('principal');
        localStorage.removeItem('annualInterestRate');
        localStorage.removeItem('stableIncome');
        localStorage.removeItem('annualExpenses');
        localStorage.removeItem('inflationRate');
        localStorage.removeItem('startYear');

        // è·å–æ¸…ç©ºåçš„ localStorage æ•°æ®
        let storedPrincipal = localStorage.getItem('principal');
        let storedAnnualInterestRate = localStorage.getItem('annualInterestRate');
        let storedStableIncome = localStorage.getItem('stableIncome');
        let storedAnnualExpenses = localStorage.getItem('annualExpenses');
        let storedInflationRate = localStorage.getItem('inflationRate');
        let storedStartYear = localStorage.getItem('startYear');

        // æ‰“å° localStorage æ•°æ®ï¼Œç¡®è®¤å…¶å·²è¢«æ¸…é™¤
        console.log(`localStorage after reset: Stored Principal: ${storedPrincipal}, Stored Annual Interest Rate: ${storedAnnualInterestRate}, Stored Stable Income: ${storedStableIncome}, Stored Annual Expenses: ${storedAnnualExpenses}, Stored Inflation Rate: ${storedInflationRate}, Stored Start Year: ${storedStartYear}`);

        // æ›´æ–°æ˜¾ç¤º
        updatePrincipalDisplay();
        updateMonthlyExpensesDisplay();
        updateStableIncomeDisplay();
        calculateInterest(); // é‡æ–°è®¡ç®—ä»¥æ›´æ–°é¡µé¢
    }
</script>
</body>
</html>
