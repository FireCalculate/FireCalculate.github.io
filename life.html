<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <link rel="icon" href="dist/favicon/life.ico"/>
    <title>ç”Ÿå‘½ä½™é¢</title>

    <!-- ä½ çš„æ ·å¼ä¸ä¾èµ– -->
    <link rel="stylesheet" type="text/css" href="dist/css/c070423032508.css">
    <link rel="stylesheet" type="text/css" href="dist/css/c220423282110.css">
    <link rel="stylesheet" href="dist/css/bootstrap.min.css">
    <script src="dist/js/jquery-3.7.0.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <script src="dist/js/bootstrap.bundle.min.js"></script>

    <!-- ä½ æåˆ°å¯ç”¨çš„å›¾è¡¨åº“ï¼ˆæœ¬å®ç°æœªç›´æ¥ä¾èµ–ï¼Œä¿ç•™ä¾¿äºæ‰©å±•ï¼‰ -->
    <script src="dist/chart.min.js"></script>
    <script src="dist/js/d3js.org_d3.v7.min.js"></script>

    <style>
        /* ========= Base ========= */
        body {
            background: #fff;
        }

        .controls-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: .75rem;
            padding: 12px 14px;
        }

        .form-label-compact {
            font-weight: 700;
            margin-bottom: .35rem;
        }

        .input-group-slim .form-control {
            text-align: center;
        }

        .btn-radio .btn {
            border-radius: 999px !important;
            padding: .25rem .85rem;
            border: 1px solid #ced4da;
        }

        .btn-radio .btn:not(.active):hover {
            background: #f8f9fa;
        }

        .btn-radio .btn.active {
            box-shadow: 0 0 0 .15rem rgba(13, 110, 253, .15) inset;
        }

        /* ========= Legend ========= */
        .legend .legend-box {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 1px solid #ced4da;
            margin-right: 6px;
            vertical-align: -2px;
        }

        .legend .legend-item {
            margin-right: 16px;
        }

        /* ========= Phase colors ========= */
        .past {
            background: #f1f3f5 !important;
            color: #868e96;
        }

        .healthy {
            background: #ffffff !important;
        }

        .frail {
            background: #fff3cd !important;
        }

        .disabled {
            background: #f8d7da !important;
        }

        /* ========= Current month highlight ========= */
        .now {
            position: relative;
            box-shadow: inset 0 0 0 2px #343a40;
            font-weight: 600;
            overflow: hidden;
        }

        .now::before, .now::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
        }

        .now::before {
            box-shadow: 0 0 0 0 rgba(52, 58, 64, .55);
            animation: pulse 1.8s ease-out infinite;
        }

        .now::after {
            background: radial-gradient(circle at 30% 30%, #495057 0%, #495057 55%, #868e96 80%, #868e96 100%);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(52, 58, 64, .55);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(52, 58, 64, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(52, 58, 64, 0);
            }
        }

        /* ========= Table ========= */
        table.lifetable thead th {
            position: sticky;
            top: 0;
            background: #212529;
            color: #fff;
            z-index: 2;
        }

        table.lifetable td, table.lifetable th {
            white-space: nowrap;
            vertical-align: middle;
        }

        table.lifetable td.month-cell {
            text-align: center;
            min-width: 38px;
        }

        table.lifetable td.year-age {
            font-variant-numeric: tabular-nums;
        }

        .phase-cell {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            text-align: center;
            font-weight: 600;
            color: #444;
            background: #fafafa;
            border-right: 1px solid #e9ecef;
            letter-spacing: 2px;
        }

        /* ========= Summary card & metrics ========= */
        .summary-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: .75rem;
        }

        .summary-kicker {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .summary-lines li {
            margin-bottom: .35rem;
        }

        .pill {
            display: inline-block;
            padding: .1rem .55rem;
            border-radius: 999px;
            font-size: .85em;
            margin-left: .35rem;
            border: 1px solid rgba(0, 0, 0, .06);
        }

        .pill-dark {
            background: #212529;
            color: #fff;
        }

        .metric-line {
            gap: .5rem;
        }

        .metric-label {
            flex: 0 0 230px;
        }

        .metric-progress {
            flex: 1 1 auto;
            min-width: 160px;
        }

        .metric-tail {
            flex: 0 0 160px;
            text-align: right;
            white-space: nowrap;
        }

        .progress {
            height: .6rem;
            background: #e9ecef;
        }

        .progress-bar {
            transition: width .6s ease;
        }

        .subtle {
            color: #6c757d;
        }

        /* ========= Responsive ========= */
        @media (max-width: 576px) {
            .phase-cell {
                writing-mode: horizontal-tb;
                letter-spacing: 1px;
            }

            .metric-progress {
                min-width: 120px;
            }

            .metric-label, .metric-tail {
                flex-basis: auto;
            }
        }

        /* ====== è¯­ä¹‰çº¹ç†ï¼ˆè¡¨æ ¼ç”¨ï¼‰ ====== */
        :root {
            --past-bg: #f1f3f5;
            --past-stroke: #dee2e6;
            --healthy-dot: #e9ecef;
            --frail-base: #fff3cd;
            --frail-stripe: #ffe69c;
            --disabled-base: #fdecec;
            --disabled-accent: rgba(240, 62, 62, .18);
        }

        table.lifetable td.month-cell {
            position: relative;
            cursor: help;
        }

        .past {
            background-image: repeating-linear-gradient(135deg, var(--past-bg) 0 8px, #e9ecef 8px 16px);
            box-shadow: inset 0 0 0 1px var(--past-stroke);
        }

        .past::after {
            content: "â³";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .9rem;
            opacity: .35;
            pointer-events: none;
        }

        .healthy {
            background-image: radial-gradient(var(--healthy-dot) .6px, transparent .6px);
            background-size: 10px 10px;
            background-color: #fff;
        }

        .frail {
            background-image: linear-gradient(180deg, var(--frail-base), var(--frail-base)), repeating-linear-gradient(45deg, transparent 0 8px, var(--frail-stripe) 8px 16px);
            background-blend-mode: multiply;
            box-shadow: inset 0 0 0 1px #ffe8a1;
        }

        .frail::after {
            content: "âš ï¸";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .95rem;
            opacity: .28;
            pointer-events: none;
        }

        .disabled {
            background-image: linear-gradient(180deg, #fff, var(--disabled-base)), repeating-linear-gradient(45deg, var(--disabled-accent) 0 10px, transparent 10px 20px), repeating-linear-gradient(-45deg, var(--disabled-accent) 0 10px, transparent 10px 20px);
            background-blend-mode: screen;
            box-shadow: inset 0 0 0 1px #f5c2c7;
        }

        .disabled::after {
            content: "âœ–";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .95rem;
            opacity: .22;
            pointer-events: none;
        }

        .legend .legend-box.legend-past {
            background-image: repeating-linear-gradient(135deg, #f1f3f5 0 8px, #e9ecef 8px 16px);
        }

        .legend .legend-box.legend-now {
            background: #fff;
            box-shadow: inset 0 0 0 2px #343a40;
        }

        .legend .legend-box.legend-healthy {
            background-image: radial-gradient(#e9ecef .6px, transparent .6px);
            background-size: 10px 10px;
            background-color: #fff;
        }

        .legend .legend-box.legend-frail {
            background-image: linear-gradient(180deg, #fff3cd, #fff3cd), repeating-linear-gradient(45deg, transparent 0 8px, #ffe69c 8px 16px);
        }

        .legend .legend-box.legend-disabled {
            background-image: linear-gradient(180deg, #fff, #fdecec), repeating-linear-gradient(45deg, rgba(240, 62, 62, .18) 0 10px, transparent 10px 20px), repeating-linear-gradient(-45deg, rgba(240, 62, 62, .18) 0 10px, transparent 10px 20px);
        }

        /* === ç»Ÿä¸€æ§ä»¶é«˜åº¦ === */
        :root {
            --control-h: 32px;
        }

        .controls-card .input-group-sm .form-control, .controls-card .input-group-sm .btn {
            height: var(--control-h);
            padding-top: .25rem;
            padding-bottom: .25rem;
        }

        .controls-card .btn-group-sm .btn {
            height: var(--control-h);
            display: inline-flex;
            align-items: center;
            line-height: 1;
        }

        .controls-card .input-group-prepend .btn, .controls-card .input-group-append .btn {
            min-width: 32px;
            justify-content: center;
        }

        .controls-card .d-flex.align-items-end {
            align-items: stretch !important;
        }

        /* ====== åœ†ç¯å¡ç‰‡ï¼ˆæ–°å¢ï¼‰ ====== */
        .ring-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: .75rem;
        }

        .ring-title {
            font-weight: 700;
            margin-bottom: .25rem;
        }

        .ring-subtle {
            color: #6c757d;
        }

        .ring-canvas-wrap {
            width: 100%;
        }

        /* è®© Canvas è‡ªé€‚åº”çˆ¶å®¹å™¨å®½åº¦ï¼›é«˜åº¦é€šè¿‡ JS è®¾ç½®æ¯”ä¾‹ */
        #lifeRingCanvas {
            width: 100%;
            display: block;
        }
    </style>
</head>
<body class="pb-5">
<div class="container-fluid py-4">

    <!-- é¡¶éƒ¨è¡Œï¼šå³ä¾§æ§ä»¶ + å·¦ä¾§æ¦‚è¦ -->
    <div class="d-flex flex-wrap align-items-start justify-content-between">
        <!-- å³ï¼šæ§ä»¶ -->
        <div class="controls-card mb-3">
            <div class="d-flex flex-wrap align-items-end" style="gap: 18px;">
                <!-- å‡ºç”Ÿå¹´ä»½ -->
                <div>
                    <label class="form-label-compact d-block">å‡ºç”Ÿå¹´ä»½</label>
                    <div class="input-group input-group-sm input-group-slim" style="max-width: 220px;">
                        <div class="input-group-prepend">
                            <button class="btn btn-outline-secondary btn-sm" id="btnBirthMinus" title="å‡ºç”Ÿå¹´ä»½ -1">-
                            </button>
                        </div>
                        <input type="number" class="form-control" id="birthYearInput" step="1" min="1900" max="2100"
                               placeholder="ä¾‹å¦‚ï¼š1998"/>
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary btn-sm" id="btnBirthPlus" title="å‡ºç”Ÿå¹´ä»½ +1">+
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="btnBirthConfirm" title="ç¡®è®¤å½“å‰è¾“å…¥">
                                ç¡®è®¤
                            </button>
                        </div>
                    </div>
                    <small class="subtle d-block mt-1">
                        å½“å‰ï¼š<span id="currentYearLabel"></span> å¹´ï¼Œå¹´é¾„ï¼š<span id="currentAgeLabel"></span> å²
                    </small>
                </div>

                <!-- æ€§åˆ«é€‰æ‹© -->
                <div>
                    <label class="form-label-compact d-block">æ€§åˆ«</label>
                    <div class="btn-group btn-radio btn-group-sm" role="group" aria-label="Gender toggle">
                        <input type="radio" class="btn-check d-none" name="sex" id="sexMale" value="male"
                               autocomplete="off">
                        <label class="btn btn-secondary" for="sexMale">ç”·ï¼ˆ75ï¼‰</label>

                        <input type="radio" class="btn-check d-none" name="sex" id="sexFemale" value="female"
                               autocomplete="off">
                        <label class="btn btn-secondary" for="sexFemale">å¥³ï¼ˆ80ï¼‰</label>
                    </div>
                    <small class="subtle d-block mt-1">ä¸­å›½ç”·/å¥³å¹³å‡å¯¿å‘½çº¦75.37/80.88å¹´</small>
                    <small class="subtle d-block mt-1"><a
                            href="https://data.stats.gov.cn/easyquery.htm?cn=C01&zb=A0304&sj=2020" target="_blank">å›½å®¶æ•°æ®...</a></small>
                </div>
            </div>
        </div>

        <!-- å·¦ï¼šæ¦‚è¦ -->
        <div class="mb-3 mr-3" style="min-width: 320px;">
            <div class="summary-card shadow-sm p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="summary-kicker mr-2">ç”Ÿå‘½æ¦‚è§ˆ</div>
                    <small id="maxAgeLabel" class="text-muted"></small>
                </div>

                <ul class="list-unstyled mb-2 summary-lines">
                    <li>å‡ºç”Ÿå¹´ä»½ <span id="birthYearLabel">--</span></li>

                    <li class="metric-line d-flex align-items-center">
                        <div class="metric-label">å½“å‰å¹´é¾„ <strong id="ageLabel">--</strong> å²</div>
                        <div class="progress metric-progress mx-2">
                            <div id="ageProgress" class="progress-bar bg-dark" role="progressbar"
                                 style="width:0%"></div>
                        </div>
                        <small class="subtle metric-tail">
                            æ€»å¯¿å‘½å·²ä½¿ç”¨ <span id="lifeUsedPctLabel">--</span>% <span id="lifeUsedFracLabel">(<span
                                id="ageUsedFracLabel2">--</span>/<span id="maxAgeTailLabel">--</span>)</span>
                        </small>
                    </li>


                    <li class="metric-line d-flex align-items-center">
                        <div class="metric-label">
                            è·ç¦»è¡°å¼±æœŸ <strong class="text-danger font-weight-bold" id="toFrailLabel">--</strong> å¹´
                            (<span id="frailStartLabel">60</span>-<span id="ageFormulaLabel1">--</span>)
                        </div>
                        <div class="progress metric-progress mx-2" title="å¥åº·æœŸå·²ä½¿ç”¨è¿›åº¦">
                            <div id="healthyProgress" class="progress-bar bg-danger" role="progressbar"
                                 style="width:0%"></div>
                        </div>
                        <small class="subtle metric-tail">å¥åº·æœŸå·²ä½¿ç”¨ <span id="healthyUsedPctLabel">--</span>%<span
                                id="healthyUsedFracLabel"></span></small>
                    </li>

                    <li class="metric-line d-flex align-items-center">
                        <div class="metric-label">è·ç¦»å¤±èƒ½æœŸ <strong class="font-weight-bold"
                                                                     id="toDisabledLabel">--</strong> å¹´
                            (<span id="disabledStartLabel">70</span>-<span id="ageFormulaLabel2">--</span>)
                        </div>
                    </li>

                    <li class="metric-line d-flex align-items-center">
                        <div class="metric-label">è·ç¦»æ­»äº¡ <strong id="lifeLeftLabel">--</strong> å¹´ (<span
                                id="maxAgeLabelDeath">70</span>-<span id="ageFormulaLabelDeath">--</span>)
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ====== æ–°å¢ï¼šç”Ÿå‘½è¿›åº¦åœ†ç¯ï¼ˆåœ¨â€œç”Ÿå‘½æ¦‚è§ˆâ€åã€è¡¨æ ¼å‰ï¼‰ ====== -->
    <div class="ring-card shadow-sm p-3 mb-3">
        <div class="d-flex align-items-baseline justify-content-between">
            <small class="ring-subtle" id="ringMeta">â€”</small>
        </div>
        <div class="ring-canvas-wrap mt-2">
            <canvas id="lifeRingCanvas" height="320" aria-label="ç”Ÿå‘½è¿›åº¦åœ†ç¯"></canvas>
        </div>
    </div>

    <!-- é¢œè‰²å›¾ä¾‹ -->
    <div class="legend my-3">
        <span class="legend-item"><span class="legend-box legend-past"></span><span id="legendPast">å·²è¿‡å»</span></span>
        <span class="legend-item"><span class="legend-box legend-now"></span><span id="legendNow">å½“å‰æœˆ</span></span>
        <span class="legend-item"><span class="legend-box legend-healthy"></span><span
                id="legendHealthy">å¥åº·æœŸ(1~59)</span></span>
        <span class="legend-item"><span class="legend-box legend-frail"></span><span
                id="legendFrail">è¡°å¼±æœŸ(60~69)</span></span>
        <span class="legend-item"><span class="legend-box legend-disabled"></span><span
                id="legendDisabled">å¤±èƒ½æœŸ(70~78)</span></span>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover lifetable">
            <thead class="thead-dark">
            <tr>
                <th class="text-center align-middle" style="width:60px;">é˜¶æ®µ</th>
                <th class="text-center align-middle" style="width:110px;">å¹´ä»½ / å¹´é¾„</th>
                <th class="text-center">1</th>
                <th class="text-center">2</th>
                <th class="text-center">3</th>
                <th class="text-center">4</th>
                <th class="text-center">5</th>
                <th class="text-center">6</th>
                <th class="text-center">7</th>
                <th class="text-center">8</th>
                <th class="text-center">9</th>
                <th class="text-center">10</th>
                <th class="text-center">11</th>
                <th class="text-center">12</th>
            </tr>
            </thead>
            <tbody id="lifeTableBody"></tbody>
        </table>
    </div>
</div>

<div class="bottom-navigation">
    <a href="index.html">ğŸ’° FIREè®¡ç®—å™¨</a>
    <a href="life.html">â° ç”Ÿå‘½å€’è®¡æ—¶</a>
    <a href="expense.html">ğŸ§¾ æ¶ˆè´¹ç›˜ç‚¹</a>
    <!--<a href="clock.html">â° FIREæ—¶é’Ÿ</a>-->
    <a href="rental.html">ğŸ  æˆ¿äº§ç§Ÿå”®æ¯”</a>
</div>

<script>
    // ====== å¸¸é‡ï¼ˆé˜¶æ®µè¾¹ç•Œå›ºå®šï¼ŒMAX_AGE å¯å˜ï¼‰======
    let MAX_AGE = 78; // åŠ¨æ€ï¼šç”·=75 / å¥³=80ï¼ˆåˆå§‹åŒ–å°†åœ¨ init/commitGender ä¸­è¦†ç›–ï¼‰
    const HEALTHY_END = 59; // å¥åº·æœŸï¼š1â€“59 å²
    const FRAIL_END = 69;   // è¡°å¼±æœŸï¼š60â€“69 å²ï¼ˆå¤±èƒ½æœŸï¼š70â€“MAX_AGEï¼‰

    // ====== å½“å‰å¹´æœˆï¼ˆæŒ‰æœ¬åœ°æ—¶åŒºï¼‰======
    const now = new Date();
    const CUR_YEAR = now.getFullYear();
    const CUR_MONTH = now.getMonth() + 1; // 1..12
    const CUR_DAY = now.getDate();

    function setLegendBySystemDate(birthYear) {
        const pad2 = n => String(n).padStart(2, '0');
        const prevYear = (CUR_MONTH === 1) ? (CUR_YEAR - 1) : CUR_YEAR;
        const prevMonth = (CUR_MONTH === 1) ? 12 : (CUR_MONTH - 1);
        const startYear = clamp(parseInt(birthYear, 10) || (CUR_YEAR - 35), 1900, 2100);
        $('#legendPast').text(`å·²è¿‡å»(${startYear}~${prevYear}-${pad2(prevMonth)})`);
        $('#legendNow').text(`å½“å‰æœˆ(${CUR_YEAR}-${pad2(CUR_MONTH)})`);
    }

    // ====== DOM ======
    const $birthInput = $('#birthYearInput');
    const $tbody = $('#lifeTableBody');

    // ====== å·¥å…·å‡½æ•° ======
    function clamp(n, min, max) {
        return Math.min(Math.max(n, min), max);
    }

    function daysInMonth(y, m) {
        return new Date(y, m, 0).getDate();
    } // m: 1..12

    function phaseByAge(age) { // age: æ•´å¹´
        if (age <= HEALTHY_END) return 'healthy';
        if (age <= FRAIL_END) return 'frail';
        return 'disabled';
    }

    function phaseLabelByAge(age) {
        const ph = phaseByAge(age);
        return ph === 'healthy' ? 'å¥åº·æœŸ' : (ph === 'frail' ? 'è¡°å¼±æœŸ' : 'å¤±èƒ½æœŸ');
    }

    function monthsClassFor(year, month, age) {
        const idx = year * 12 + month;
        const curIdx = CUR_YEAR * 12 + CUR_MONTH;
        if (idx < curIdx) return 'past';
        const ph = phaseByAge(age);
        if (ph === 'healthy') return 'healthy';
        if (ph === 'frail') return 'frail';
        return 'disabled';
    }

    function fmtPct(n) {
        n = Math.max(0, Math.min(100, n));
        return n.toFixed(2);
    }

    function updateHeader(birthYear) {
        const age = CUR_YEAR - birthYear;
        const lifeLeft = clamp(MAX_AGE - age, 0, MAX_AGE);
        const agePct = (age <= 0) ? 0 : Math.min((age / MAX_AGE) * 100, 100);
        const FRAIL_START = HEALTHY_END + 1; // 60
        const DISABLED_START = FRAIL_END + 1; // 70

        const healthyUsedPct = clamp((age / HEALTHY_END) * 100, 0, 100);
        $('#healthyProgress').css('width', `${fmtPct(healthyUsedPct)}%`)
            .attr('aria-valuenow', fmtPct(healthyUsedPct))
            .attr('title', `å¥åº·æœŸå·²ä½¿ç”¨ ${fmtPct(healthyUsedPct)}%`);
        $('#healthyUsedPctLabel').text(fmtPct(healthyUsedPct));
        const healthyNumerator = clamp(age, 0, HEALTHY_END);
        $('#healthyUsedFracLabel').text(`(${healthyNumerator}/${HEALTHY_END})`);

        const toFrail = clamp(FRAIL_START - age, 0, MAX_AGE);
        const toDisabled = clamp(DISABLED_START - age, 0, MAX_AGE);

        $('#birthYearLabel').text(birthYear);
        $('#ageLabel').text(age);
        $('#lifeLeftLabel').text(lifeLeft);
        $('#lifeUsedPctLabel').text(fmtPct(agePct));
        $('#ageUsedFracLabel2').text(age);
        $('#maxAgeTailLabel').text(MAX_AGE);

        $('#toFrailLabel').text(toFrail);
        $('#frailStartLabel').text(FRAIL_START);
        $('#ageFormulaLabel1').text(age);
        $('#toDisabledLabel').text(toDisabled);
        $('#disabledStartLabel').text(DISABLED_START);
        $('#ageFormulaLabel2').text(age);

        $('#maxAgeLabelDeath').text(MAX_AGE);
        $('#ageFormulaLabelDeath').text(age);

        $('#ageProgress').css('width', `${fmtPct(agePct)}%`);
        $('#currentYearLabel').text(CUR_YEAR);
        $('#currentAgeLabel').text(age);
    }

    // è¡ŒåŠ¨å‹æ‚¬åœæç¤º
    function tipForPhase(cls) {
        const tips = {
            past: 'å·²è¿‡å»ï½œå¯åšå¤ç›˜ï¼šå“ªäº›å€¼å¾—ç»§ç»­ï¼Ÿå“ªäº›åº”å½“èˆå¼ƒï¼Ÿ',
            healthy: 'å¥åº·æœŸï½œæ‰“åŸºç¡€ï¼šé˜»åŠ›è®­ç»ƒ/å¿ƒè‚º/ç¡çœ /ä½“æ£€/æˆ’çƒŸé™é…’',
            frail: 'è¡°å¼±æœŸï½œé˜²è·Œå€’ä¸è‚Œå°‘ï¼šåŠ›é‡è®­ç»ƒã€ç»´D/é’™ã€æ…¢ç—…ç®¡ç†',
            disabled: 'å¤±èƒ½æœŸï½œæå‰è§„åˆ’ç…§æŠ¤ï¼šæ— éšœç¢æ”¹é€ ã€æ„å®šç›‘æŠ¤/æˆæƒ'
        };
        return tips[cls] || '';
    }

    // ç”Ÿæˆæ•´å¼ è¡¨
    function buildTable(birthYear) {
        $tbody.empty();
        const HEALTH_ROWS = HEALTHY_END;              // 1..59
        const FRAIL_ROWS = FRAIL_END - HEALTHY_END;  // 60..69 -> 10
        const DISAB_ROWS = MAX_AGE - FRAIL_END;      // 70..MAX_AGE

        for (let age = 1; age <= MAX_AGE; age++) {
            const year = birthYear + (age - 1);
            const $tr = $('<tr></tr>');

            if (age === 1) {
                $tr.append(`<td class="phase-cell align-middle text-center" rowspan="${HEALTH_ROWS}">å¥åº·æœŸ(1~${HEALTHY_END})</td>`);
            } else if (age === HEALTHY_END + 1) {
                $tr.append(`<td class="phase-cell align-middle text-center" rowspan="${FRAIL_ROWS}">è¡°å¼±æœŸ(${HEALTHY_END + 1}~${FRAIL_END})</td>`);
            } else if (age === FRAIL_END + 1) {
                $tr.append(`<td class="phase-cell align-middle text-center" rowspan="${DISAB_ROWS}">å¤±èƒ½æœŸ(${FRAIL_END + 1}~${MAX_AGE})</td>`);
            }

            $tr.append(`<td class="year-age text-center font-weight-500">${year} / ${age}</td>`);

            for (let m = 1; m <= 12; m++) {
                const cls = monthsClassFor(year, m, age);
                const isNow = (year === CUR_YEAR && m === CUR_MONTH);
                const label = phaseLabelByAge(age);
                const mm = String(m).padStart(2, '0');
                const title = isNow
                    ? `å½“å‰æœˆ ${year}-${mm}ï½œåšä¸€ä»¶é‡è¦çš„å°äº‹`
                    : `${year}-${mm}ï½œ${label}ï½œ${tipForPhase(cls)}`;
                $tr.append(`<td class="month-cell ${cls} ${isNow ? 'now' : ''}" title="${title}" aria-label="${title}">&nbsp;</td>`);
            }
            $tbody.append($tr);
        }
    }

    // ====== æ€§åˆ«ç›¸å…³ ======
    function genderFromUI() {
        const v = $('input[name="sex"]:checked').val();
        return v === 'female' ? 'female' : 'male';
    }

    function maxAgeByGender(g) {
        return g === 'female' ? 80 : 75;
    }

    function applyMaxAge(newMaxAge, birthYear) {
        MAX_AGE = newMaxAge;
        const g = genderFromUI();
        $('#maxAgeLabel').text(`åŸºäº${g === 'female' ? 'å¥³' : 'ç”·'}æ€§å¯¿å‘½ ${MAX_AGE} å²`);
        $('#legendHealthy').text(`å¥åº·æœŸ(1~${HEALTHY_END})`);
        $('#legendFrail').text(`è¡°å¼±æœŸ(${HEALTHY_END + 1}~${FRAIL_END})`);
        $('#legendDisabled').text(`å¤±èƒ½æœŸ(${FRAIL_END + 1}~${MAX_AGE})`);

        updateHeader(birthYear);
        buildTable(birthYear);
        setLegendBySystemDate(birthYear);
        drawLifeRing(birthYear); // <<< é‡ç»˜åœ†ç¯
    }

    function commitGender() {
        const g = genderFromUI();
        localStorage.setItem('life_gender', g);
        const by = parseInt($('#birthYearInput').val(), 10) || (CUR_YEAR - 35);
        applyMaxAge(maxAgeByGender(g), by);

        // æ›´æ–°æ€§åˆ«æŒ‰é’®å¤–è§‚ï¼ˆä¿ç•™ä½ åŸæœ‰æ ·å¼å‘½åï¼‰
        $('.btn-radio .btn').removeClass('active btn-primary').addClass('btn-light');
        if (g === 'female') {
            $('label[for="sexFemale"]').addClass('active').removeClass('btn-light');
        } else {
            $('label[for="sexMale"]').addClass('active').removeClass('btn-light');
        }
    }

    /**
     * æäº¤å‡ºç”Ÿå¹´ä»½ï¼š
     *  - preserveTyping: true æ—¶ï¼Œä¸å›å†™è¾“å…¥æ¡†ï¼ˆé¿å…æ‰“å­—ä¸­è¢«â€œ1900/2100â€è¦†ç›–ï¼‰
     *  - noStore: true æ—¶ï¼Œä¸å†™ localStorageï¼ˆå®æ—¶è¾“å…¥è¿‡ç¨‹å‡å°‘æ— æ„ä¹‰å†™å…¥ï¼‰
     *  - live: true æ—¶ï¼Œä»…å½“è¾“å…¥æ»¡4ä½æ•°å­—æ‰è§¦å‘è®¡ç®—ï¼ˆé¿å…è¾“å…¥1/19/199æ—¶åå¤è·³åˆ°1900ï¼‰
     */
    function commitBirthYear(rawVal, opts = {}) {
        const {preserveTyping = false, noStore = false, live = false} = opts;
        const s = String(rawVal ?? '').trim();

        if (live) {
            // ä»…å½“æ˜¯ 1~4 ä½æ•°å­—æ—¶ç»§ç»­ï¼›æœªæ»¡4ä½å…ˆä¸è§¦å‘æ¸²æŸ“ï¼ˆâ€œå®æ—¶ç›´æ¥è§¦å‘â€é’ˆå¯¹æœ‰æ•ˆå¹´ä»½ï¼‰
            if (!/^\d{1,4}$/.test(s)) return;
            if (s.length < 4) return;
        }

        let by = parseInt(s, 10);
        if (isNaN(by)) by = CUR_YEAR - 35;
        by = clamp(by, 1900, 2100);

        if (!preserveTyping) $birthInput.val(by);
        if (!noStore) localStorage.setItem('life_birth_year', by);

        const g = genderFromUI();
        applyMaxAge(maxAgeByGender(g), by);
    }

    // â€”â€” äº‹ä»¶ç»‘å®š â€”â€” //
    $('#btnBirthMinus').on('click', function () {
        const v = parseInt($birthInput.val(), 10) || CUR_YEAR - 35;
        commitBirthYear(v - 1);
    });
    $('#btnBirthPlus').on('click', function () {
        const v = parseInt($birthInput.val(), 10) || CUR_YEAR - 35;
        commitBirthYear(v + 1);
    });
    $('#btnBirthConfirm').on('click', function () {
        commitBirthYear($birthInput.val());
    });

    // â˜…â˜…â˜… å®æ—¶è§¦å‘ï¼šåœ¨è¾“å…¥æ¡†å˜åŒ–æ—¶ç«‹å³è®¡ç®—ä¸æ¸²æŸ“ï¼ˆæ— é˜²æŠ–ï¼‰
    $birthInput.on('input', function () {
        commitBirthYear(this.value, {preserveTyping: true, noStore: true, live: true});
    });

    // å›è½¦ç¡®è®¤ä»ç„¶å¯ç”¨
    $birthInput.on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            commitBirthYear($birthInput.val()); // ç›´æ¥æäº¤
        }
    });

    $('input[name="sex"]').on('change', function () {
        commitGender();
    });

    // ====== ç”Ÿå‘½è¿›åº¦åœ†ç¯ç»˜åˆ¶ï¼ˆåŸç”Ÿ Canvasï¼‰ ======
    function drawLifeRing(birthYear) {
        const canvas = document.getElementById('lifeRingCanvas');
        if (!canvas) return;

        // è‡ªé€‚åº” DPR
        const dpr = window.devicePixelRatio || 1;
        const parentW = canvas.clientWidth || 600;
        const targetH = 320; // è§†è§‰é«˜åº¦ï¼ˆå¯æŒ‰éœ€æ”¹ï¼‰
        canvas.width = Math.floor(parentW * dpr);
        canvas.height = Math.floor(targetH * dpr);
        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // æ–¹ä¾¿ç”¨ CSS åƒç´ ä½œå›¾

        const W = parentW, H = targetH;
        const cx = W / 2, cy = H / 2 + 6; // ç¨å¾®ä¸‹ç§»å±…ä¸­
        const outerR = Math.min(W, H) * 0.42;   // å¤–åŠå¾„
        const innerR = outerR - 32;            // ç¯å®½ ~32px
        const tickLen = 8;                     // åˆ»åº¦é•¿åº¦
        const startDeg = -90 + 6;              // ä»¥â€œ01åˆ†åˆ»åº¦â€ä¸ºèµ·ç‚¹ï¼šé¡¶ä¸Š +6Â°
        const startRad = startDeg * Math.PI / 180;
        const TAU = Math.PI * 2;

        // é¢œè‰²å–ä¸ä½ è¡¨æ ¼ä¸€è‡´çš„é£æ ¼
        const COLOR_BG = '#ffffff';
        themeColors = {
            RING_BORDER: '#e9ecef',
            HEALTHY: '#f8f9fa',
            FRAIL: '#fff3cd',
            DISABLED: '#fdecec',
            PAST: 'rgba(173,181,189,.55)',
            TICK: '#6c757d',
            TICK_PAST: '#adb5bd',
            POINTER: '#343a40',
            TEXT: '#495057'
        };

        // å¹´é¾„åˆ†æ•°ï¼ˆåŒ…å«æœˆã€æ—¥ï¼‰
        const ageFrac = clamp((CUR_YEAR - birthYear), 0, MAX_AGE); // [0, MAX_AGE]
        const ageInt = Math.floor(ageFrac);
        const phaseNow = phaseLabelByAge(Math.max(1, ageInt));

        // å°†â€œå¹´é¾„å€¼â€æ˜ å°„åˆ°è§’åº¦
        const angOf = (val) => startRad + TAU * (val / MAX_AGE);

        // å¿«é€Ÿç»˜åˆ¶åœ†ç¯æ‰‡å½¢æ®µ
        function drawRingSlice(a0, a1, fill) {
            ctx.beginPath();
            ctx.arc(cx, cy, outerR, a0, a1, false);
            ctx.arc(cx, cy, innerR, a1, a0, true);
            ctx.closePath();
            ctx.fillStyle = fill;
            ctx.fill();
            // ç»†è¾¹
            ctx.strokeStyle = themeColors.RING_BORDER;
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        // èƒŒæ™¯
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle = COLOR_BG;
        ctx.fillRect(0, 0, W, H);

        // è®¡ç®—ä¸‰ä¸ªé˜¶æ®µå¯¹åº”è§’åº¦
        const aHealthy0 = angOf(0);
        const aHealthy1 = angOf(HEALTHY_END);
        const aFrail0 = angOf(HEALTHY_END);
        const aFrail1 = angOf(FRAIL_END);
        const aDisab0 = angOf(FRAIL_END);
        const aDisab1 = angOf(MAX_AGE);

        // ç”»åˆ†æ®µåº•è‰²ï¼ˆä¸è¡¨æ ¼ä¸€è‡´ï¼‰
        drawRingSlice(aHealthy0, aHealthy1, themeColors.HEALTHY);
        drawRingSlice(aFrail0, aFrail1, themeColors.FRAIL);
        drawRingSlice(aDisab0, aDisab1, themeColors.DISABLED);

        // å åŠ â€œå·²è¿‡å»â€é˜´å½±ï¼ˆä»èµ·ç‚¹åˆ°å½“å‰æŒ‡é’ˆè§’ï¼‰
        const aPast1 = angOf(ageFrac);
        ctx.globalAlpha = 1;
        ctx.beginPath();
        ctx.arc(cx, cy, outerR, startRad, aPast1, false);
        ctx.arc(cx, cy, innerR, aPast1, startRad, true);
        ctx.closePath();
        ctx.fillStyle = themeColors.PAST;
        ctx.fill();

        // åˆ»åº¦ï¼ˆ1 ~ MAX_AGEï¼‰
        ctx.lineCap = 'round';
        for (let i = 1; i <= MAX_AGE; i++) {
            const a = angOf(i);
            const cos = Math.cos(a), sin = Math.sin(a);
            const r0 = outerR - 2;
            const r1 = r0 - tickLen;

            ctx.beginPath();
            ctx.moveTo(cx + r0 * cos, cy + r0 * sin);
            ctx.lineTo(cx + r1 * cos, cy + r1 * sin);

            if (i <= ageInt) ctx.strokeStyle = themeColors.TICK_PAST;
            else if (i === ageInt + 1) ctx.strokeStyle = themeColors.POINTER; // å½“å‰æ‰€åœ¨çš„â€œè¿™ä¸ªå¹´â€
            else ctx.strokeStyle = themeColors.TICK;

            ctx.lineWidth = (i % 5 === 0) ? 2 : 1.2; // æ¯5å¹´åŠ ç²—
            ctx.stroke();
        }

        // æŒ‡é’ˆï¼ˆæŒ‡å‘å½“å‰â€œå¹´+æœˆ+æ—¥â€çš„ç²¾ç¡®è§’åº¦ï¼‰
        const aPointer = aPast1;
        const cosP = Math.cos(aPointer), sinP = Math.sin(aPointer);
        const pointerR0 = innerR - 10;
        const pointerR1 = outerR + 10;
        ctx.beginPath();
        ctx.moveTo(cx + pointerR0 * cosP, cy + pointerR0 * sinP);
        ctx.lineTo(cx + pointerR1 * cosP, cy + pointerR1 * sinP);
        ctx.strokeStyle = themeColors.POINTER;
        ctx.lineWidth = 2.2;
        ctx.stroke();

        // æŒ‡é’ˆç«¯ç‚¹å°åœ†ç‚¹
        ctx.beginPath();
        ctx.arc(cx + (outerR + 10) * cosP, cy + (outerR + 10) * sinP, 3.5, 0, TAU);
        ctx.fillStyle = themeColors.POINTER;
        ctx.fill();

        // æ®µå†…æ–‡å­—
        ctx.fillStyle = themeColors.TEXT;
        ctx.font = '600 14px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const midR = (innerR + outerR) / 2;

        function labelAt(midFrom, midTo, text) {
            const am = (midFrom + midTo) / 2;
            const x = cx + midR * Math.cos(am);
            const y = cy + midR * Math.sin(am);
            ctx.fillText(text, x, y);
        }

        labelAt(aHealthy0, aHealthy1, `å¥åº·æœŸ 1â€“${HEALTHY_END}`);
        labelAt(aFrail0, aFrail1, `è¡°å¼±æœŸ ${HEALTHY_END + 1}â€“${FRAIL_END}`);
        labelAt(aDisab0, aDisab1, `å¤±èƒ½æœŸ ${FRAIL_END + 1}â€“${MAX_AGE}`);

        // åœ†å¿ƒæç¤º
        const usedPct = (ageFrac / HEALTHY_END) * 100;
        ctx.font = '700 18px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
        ctx.fillText(`${phaseNow}`, cx, cy - 4);
        ctx.font = '12px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
        ctx.fillText(`å·²ç”¨ ${usedPct.toFixed(2)}%\nè¿˜å‰© ${HEALTHY_END + 1 - ageFrac}å¹´`, cx, cy + 14);

        // é¡µé¢å³ä¸Šè§’å°å…ƒä¿¡æ¯
        const ym = `${CUR_YEAR}-${String(CUR_MONTH).padStart(2, '0')}`;
        $('#ringMeta').text(`å½“å‰æœˆï¼š${ym}ï½œé˜¶æ®µï¼š${phaseNow}`);
    }

    // ====== åˆå§‹æ¸²æŸ“ ======
    (function init() {
        const savedBirth = parseInt(localStorage.getItem('life_birth_year'), 10);
        const defaultBirth = !isNaN(savedBirth) ? savedBirth : (CUR_YEAR - 35);
        $birthInput.val(defaultBirth);

        const savedGender = localStorage.getItem('life_gender') || 'male';
        if (savedGender === 'female') {
            $('#sexFemale').prop('checked', true);
        } else {
            $('#sexMale').prop('checked', true);
        }

        // é¦–æ¬¡æ¸²æŸ“
        applyMaxAge(maxAgeByGender(savedGender), defaultBirth);

        // åˆå§‹åŒ–æ€§åˆ«æŒ‰é’®å¤–è§‚
        commitGender();

        // è‡ªé€‚åº”çª—å£å˜åŒ–ï¼šé‡ç»˜åœ†ç¯
        window.addEventListener('resize', () => {
            const by = parseInt($('#birthYearInput').val(), 10) || (CUR_YEAR - 35);
            drawLifeRing(by);
        });
    })();
</script>
</body>
</html>
